<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Platforms Report</title>
    <style id="mainStyles">
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --primary: #6366f1;
            --accent-green: #10b981;
            --accent-red: #f43f5e;
            --tooltip-bg: #f8fafc;
            --tooltip-text: #0f172a;

            /* Chart Gradients */
            --pie-fill: #3b82f6;
            --pie-empty: #334155;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1100px;
            width: 100%;
            display: grid;
            gap: 24px;
            animation: fadeIn 0.5s ease-out;
        }

        /* --- CARD STYLES --- */
        .card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }

        h1 { margin: 0; font-size: 1.8rem; letter-spacing: -0.02em; color: white; }
        h2 { margin-top: 0; font-size: 1.1rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px;}
        h3 { font-size: 1rem; color: var(--primary); margin: 0 0 15px 0; text-transform: uppercase; letter-spacing: 0.05em; display:flex; align-items:center; gap:8px;}

        /* --- REPORT RENDERING --- */
        .report-grid { display: grid; gap: 30px; grid-template-columns: 1fr; }
        @media(min-width: 900px) { .report-grid { grid-template-columns: 1fr 1fr 1fr; } }

        .team-block { margin-bottom: 16px; border-left: 2px solid var(--border); padding-left: 12px; }
        .team-name { color: var(--text-main); font-weight: 700; font-size: 0.95rem; display: block; margin-bottom: 4px; }
        .team-content ul { margin: 0 0 0 18px; padding: 0; color: #cbd5e1; font-size: 0.9rem; }
        .team-content li { margin-bottom: 4px; line-height: 1.4; }
        .team-content .empty { color: var(--text-muted); font-style: italic; font-size: 0.85rem; opacity: 0.6; }

        /* --- PROJECT PIE CHARTS --- */
        .projects-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px dashed var(--border);
        }

        .project-card {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .pie-chart {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 10px auto;
            position: relative;
            /* Conic Gradient injected via JS */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pie-chart::after {
            content: '';
            position: absolute;
            width: 80px;
            height: 80px;
            background: var(--bg-card); /* Creates Donut hole */
            border-radius: 50%;
        }

        .pie-text {
            position: absolute;
            z-index: 10;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .proj-title { font-weight: 600; color: var(--text-main); font-size: 0.95rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .proj-meta { color: var(--text-muted); font-size: 0.8rem; }

        /* --- INPUT TABLES --- */
        .input-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .input-table th { text-align: left; color: var(--text-muted); font-size: 0.8rem; padding-bottom: 5px; }
        .input-table td { padding: 4px; }
        .input-table input {
            width: 100%; background: #0f172a; border: 1px solid var(--border); color: white;
            padding: 8px; border-radius: 4px; font-family: inherit; font-size: 0.9rem;
        }
        .input-table input:focus { border-color: var(--primary); outline: none; }

        /* --- CHART WRAPPER --- */
        .chart-wrapper {
            position: relative; height: 350px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto; overflow-y: hidden;
            display: flex; align-items: flex-end;
            padding-top: 60px; padding-bottom: 40px;
        }
        .chart-wrapper::-webkit-scrollbar { height: 8px; }
        .chart-wrapper::-webkit-scrollbar-track { background: var(--bg-body); border-radius: 4px; }
        .chart-wrapper::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .day-column { flex: 1; min-width: 50px; max-width: 100px; height: 100%; margin: 0 8px; display: flex; flex-direction: column-reverse; position: relative; transition: opacity 0.2s; }
        .day-column:hover { opacity: 1; }
        .chart-wrapper:hover .day-column:not(:hover) { opacity: 0.4; }
        .day-column:hover::after { content: attr(data-tooltip); position: absolute; top: -45px; left: 50%; transform: translateX(-50%); background: var(--tooltip-bg); color: var(--tooltip-text); padding: 6px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; white-space: nowrap; z-index: 100; }
        .day-column:hover::before { content: ''; position: absolute; top: -15px; left: 50%; transform: translateX(-50%); border-width: 6px; border-style: solid; border-color: var(--tooltip-bg) transparent transparent transparent; z-index: 100; }
        .stack-segment { width: 100%; transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 1px; }
        .date-label { position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%) rotate(-45deg); transform-origin: top center; font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; font-family: monospace; }

        .legend { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border); }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-main); }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }

        /* --- CONTROLS --- */
        .toggle-group { display: inline-flex; background: #0f172a; padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
        .toggle-btn { padding: 6px 16px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .toggle-btn.active { background: var(--primary); color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .header-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }

        /* --- TEXT INPUTS --- */
        textarea { width: 100%; padding: 12px; background: #0f172a; color: var(--text-main); border: 1px solid var(--border); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 0.95rem; resize: vertical; box-sizing: border-box; line-height: 1.5; margin-bottom: 10px; }
        textarea:focus { outline: none; border-color: var(--primary); }

        .hidden { display: none; }
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        button:hover { filter: brightness(1.1); }
        button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        button.secondary:hover { background: rgba(255,255,255,0.05); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ========================================= */
        /* ============ PRINT OVERRIDES ============ */
        /* ========================================= */
        @media print {
            /* 1. Reset Colors to Light Mode for Paper */
            :root {
                --bg-body: #ffffff;
                --bg-card: #ffffff;
                --text-main: #000000;
                --text-muted: #555555;
                --border: #cccccc;
                --pie-empty: #e2e8f0; /* Light gray for charts */
            }

            /* 2. Page Setup */
            @page { margin: 1cm; size: auto; }

            body {
                background: white !important;
                color: black !important;
                display: block !important;
                padding: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* 3. Hide Interactive Elements */
            .no-print, button, .btn-row, .toggle-group, .secondary, textarea, #editMode {
                display: none !important;
            }

            /* 4. Layout Fixes */
            .container {
                width: 100% !important;
                max-width: none !important;
                padding: 0 !important;
                margin: 0 !important;
                display: block !important;
            }

            .card {
                background: white !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
                margin-bottom: 20px !important;
                break-inside: avoid !important;
                page-break-inside: avoid !important;
            }

            /* 5. Typography & Visibility Fixes */
            h1 { color: black !important; font-size: 24pt !important; border: none !important; }
            h2 { color: #333 !important; border-bottom: 2px solid #000 !important; }
            .team-name { color: #000 !important; }
            .team-content ul { color: #000 !important; }

            /* Fix Pie Chart donut hole */
            .pie-chart::after { background: white !important; }

            /* Ensure charts render */
            .stack-segment { border: 1px solid white; }

            /* Allow Grid to use full width */
            .report-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr 1fr !important;
                gap: 20px !important;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div style="border-bottom: 1px solid var(--border); padding-bottom: 20px; display:flex; justify-content:space-between; align-items:end;">
        <h1 id="pageTitle">Server Platforms</h1>
        <button onclick="downloadSnapshot()" class="secondary" title="Save a read-only version">üíæ Save Read-Only Report</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Weekly Management Report</h2>
            <div class="no-print">
                <button id="btnEdit" class="secondary" onclick="toggleEdit(true)">Edit Full Report</button>
                <button id="btnSave" class="hidden" onclick="saveReport()">Save & Render</button>
            </div>
        </div>

        <div id="viewMode">
            <div class="report-grid">
                <div><h3>‚≠ê Highlights</h3><div id="outHighlights"></div></div>
                <div><h3 style="color:var(--accent-red)">‚ö†Ô∏è Challenges</h3><div id="outChallenges"></div></div>
                <div><h3 style="color:var(--accent-green)">‚è≠Ô∏è Next Week</h3><div id="outNextWeek"></div></div>
            </div>

            <div id="projectSection" class="hidden">
                <h3 style="margin-top:30px; border-top:1px dashed var(--border); padding-top:20px;">üöÄ Project Status</h3>
                <div id="projectContainer" class="projects-container"></div>
            </div>
        </div>

        <div id="editMode" class="hidden">
            <label style="display:block; margin-bottom:8px; color:var(--text-muted); font-weight:600;">Text Report (Highlights, Challenges, Next Week)</label>
            <textarea id="rawReportInput" rows="15" placeholder="Weekly Highlights..."></textarea>

            <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
                <label style="display:block; margin-bottom:12px; color:var(--text-muted); font-weight:600;">Project Tracking (Max 5)</label>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th style="width:30%">Project Name</th>
                            <th style="width:25%">Description (e.g. Servers)</th>
                            <th style="width:15%">Total</th>
                            <th style="width:15%">Done</th>
                        </tr>
                    </thead>
                    <tbody id="projectInputBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="header-row">
            <h2>Incident & Request Trends</h2>
            <div class="toggle-group">
                <button class="toggle-btn active" onclick="setMetric('incidents', this)">Incidents</button>
                <button class="toggle-btn" onclick="setMetric('requests', this)">Requests</button>
                <button class="toggle-btn" onclick="setMetric('total', this)">Total Work</button>
            </div>
        </div>
        <div id="chartContainer" class="chart-wrapper"></div>
        <div id="legendContainer" class="legend"></div>
    </div>

    <div class="card no-print">
        <h2>Data Import</h2>
        <textarea id="inputData" style="height:80px; font-family:monospace;" placeholder="Datestamp,Category,Incidents,Requests&#10;2026-01-02,Unix/Linux,11,12..."></textarea>
        <div class="btn-row">
            <button onclick="processData()">Import CSV</button>
            <button class="secondary" onclick="exportData()">Export CSV</button>
            <button class="secondary" style="color:#f43f5e; border-color:rgba(244,63,94,0.3)" onclick="clearAll()">Reset All</button>
        </div>
    </div>
</div>

<script>
    const KEY_DATA = 'ops_report_data_v5';
    const KEY_TEXT = 'ops_report_raw_v5';
    const KEY_PROJ = 'ops_report_proj_v5';

    let appData = [];
    let projectData = []; // Array of 5 objects
    let currentMetric = 'incidents';
    const COLORS = ['#818cf8', '#f472b6', '#22d3ee', '#fbbf24', '#34d399', '#a78bfa', '#fb7185', '#60a5fa', '#a3e635'];
    const KNOWN_TEAMS = ['Unix/Linux', 'Windows/VMWare', 'Azure', 'Build', 'Patching'];

    window.addEventListener('DOMContentLoaded', () => {
        setDynamicTitle();
        generateProjectInputs();
        loadData();
        if(appData.length > 0) renderChart();
        loadReport();
    });

    function setDynamicTitle() {
        const today = new Date();
        const dateStr = today.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        document.getElementById('pageTitle').innerText = `Server Platforms - ${dateStr}`;
        document.title = `Server Platforms - ${dateStr}`;
    }

    // --- PROJECT LOGIC ---
    function generateProjectInputs() {
        const tbody = document.getElementById('projectInputBody');
        let html = '';
        for(let i=0; i<5; i++) {
            html += `
            <tr>
                <td><input type="text" id="pName${i}" placeholder="Project ${i+1}"></td>
                <td><input type="text" id="pDesc${i}" placeholder="Unit to track"></td>
                <td><input type="number" id="pTotal${i}" placeholder="0"></td>
                <td><input type="number" id="pDone${i}" placeholder="0"></td>
            </tr>`;
        }
        tbody.innerHTML = html;
    }

    function saveProjects() {
        projectData = [];
        for(let i=0; i<5; i++) {
            const name = document.getElementById(`pName${i}`).value.trim();
            if(name) {
                projectData.push({
                    name: name,
                    desc: document.getElementById(`pDesc${i}`).value.trim() || 'Items',
                    total: parseInt(document.getElementById(`pTotal${i}`).value) || 0,
                    done: parseInt(document.getElementById(`pDone${i}`).value) || 0
                });
            }
        }
        localStorage.setItem(KEY_PROJ, JSON.stringify(projectData));
        renderProjects();
    }

    function loadProjects() {
        const stored = localStorage.getItem(KEY_PROJ);
        if(stored) projectData = JSON.parse(stored);

        // Fill Inputs
        projectData.forEach((p, i) => {
            if(i < 5) {
                document.getElementById(`pName${i}`).value = p.name;
                document.getElementById(`pDesc${i}`).value = p.desc;
                document.getElementById(`pTotal${i}`).value = p.total;
                document.getElementById(`pDone${i}`).value = p.done;
            }
        });
        renderProjects();
    }

    function renderProjects() {
        const container = document.getElementById('projectContainer');
        const section = document.getElementById('projectSection');

        if(!projectData || projectData.length === 0) {
            section.classList.add('hidden');
            return;
        }

        section.classList.remove('hidden');
        let html = '';

        projectData.forEach(p => {
            const total = p.total || 1; // avoid divide by zero
            const pct = Math.min(100, Math.round((p.done / total) * 100));

            // Generate Color based on hash of name for consistency
            let hash = 0;
            for (let i = 0; i < p.name.length; i++) hash = p.name.charCodeAt(i) + ((hash << 5) - hash);
            const color = COLORS[Math.abs(hash) % COLORS.length];

            html += `
            <div class="project-card">
                <div class="proj-title">${p.name}</div>
                <div class="pie-chart" style="background: conic-gradient(${color} ${pct}%, var(--pie-empty) 0);">
                    <span class="pie-text">${pct}%</span>
                </div>
                <div class="proj-meta">${p.done} / ${p.total} ${p.desc}</div>
            </div>`;
        });
        container.innerHTML = html;
    }

    // --- REPORT LOGIC ---
    function toggleEdit(isEdit) {
        document.getElementById('viewMode').classList.toggle('hidden', isEdit);
        document.getElementById('editMode').classList.toggle('hidden', !isEdit);
        document.getElementById('btnEdit').classList.toggle('hidden', isEdit);
        document.getElementById('btnSave').classList.toggle('hidden', !isEdit);
    }

    function saveReport() {
        const raw = document.getElementById('rawReportInput').value;
        localStorage.setItem(KEY_TEXT, raw);
        saveProjects(); // Save project inputs too
        parseAndRender(raw);
        toggleEdit(false);
    }

    function loadReport() {
        loadProjects(); // Load projects first
        const stored = localStorage.getItem(KEY_TEXT);
        if (stored) { document.getElementById('rawReportInput').value = stored; parseAndRender(stored); }
        else { parseAndRender(""); }
    }

    // --- SNAPSHOT GENERATOR ---
    function downloadSnapshot() {
        const css = document.getElementById('mainStyles').innerHTML;
        const title = document.getElementById('pageTitle').innerText;

        // Serialize Data
        const dJson = JSON.stringify(appData);
        const pJson = JSON.stringify(projectData);
        const rJson = JSON.stringify(document.getElementById('rawReportInput').value);

        const snapshotHtml = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>${title}</title><style>${css} .no-print{display:none!important}</style></head><body><div class="container"><div style="border-bottom:1px solid var(--border);padding-bottom:20px;"><h1>${title}</h1><p style="color:var(--text-muted)">Read-Only Report</p></div><div class="card"><h2>Weekly Management Report</h2><div id="viewMode"><div class="report-grid"><div><h3>‚≠ê Highlights</h3><div id="outHighlights"></div></div><div><h3 style="color:var(--accent-red)">‚ö†Ô∏è Challenges</h3><div id="outChallenges"></div></div><div><h3 style="color:var(--accent-green)">‚è≠Ô∏è Next Week</h3><div id="outNextWeek"></div></div></div><div id="projectSection" class="hidden"><h3 style="margin-top:30px;border-top:1px dashed var(--border);padding-top:20px;">üöÄ Project Status</h3><div id="projectContainer" class="projects-container"></div></div></div></div><div class="card"><div class="header-row"><h2>Incident & Request Trends</h2><div class="toggle-group"><button class="toggle-btn active" onclick="setMetric('incidents',this)">Incidents</button><button class="toggle-btn" onclick="setMetric('requests',this)">Requests</button><button class="toggle-btn" onclick="setMetric('total',this)">Total Work</button></div></div><div id="chartContainer" class="chart-wrapper"></div><div id="legendContainer" class="legend"></div></div></div><script>
    const appData=${dJson},projectData=${pJson},rawReport=${rJson},COLORS=['#818cf8','#f472b6','#22d3ee','#fbbf24','#34d399','#a78bfa','#fb7185','#60a5fa','#a3e635'],KNOWN_TEAMS=['Unix/Linux','Windows/VMWare','Azure','Build','Patching'];
    let currentMetric='incidents';
    // Logic Minified
    function parseAndRender(t){if(!t)return;const cRegex=/(?:\\n|^)\\s*(?:Challenges|Issues|Blockers)\\s*(?:\\n|$)/i,nRegex=/(?:\\n|^)\\s*(?:Coming\\s+)?Next\\s+Week\\s*(?:\\n|$)/i;let h="",c="",n="";const cm=t.match(cRegex),nm=t.match(nRegex),ci=cm?cm.index:-1,ni=nm?nm.index:-1;if(ci===-1&&ni===-1)h=t;else if(ci!==-1&&ni===-1){h=t.substring(0,ci);c=t.substring(ci+cm[0].length)}else if(ci===-1&&ni!==-1){h=t.substring(0,ni);n=t.substring(ni+nm[0].length)}else{if(ci<ni){h=t.substring(0,ci);c=t.substring(ci+cm[0].length,ni);n=t.substring(ni+nm[0].length)}else{h=t.substring(0,ni);n=t.substring(ni+nm[0].length,ci);c=t.substring(ci+cm[0].length)}}h=h.replace(/^(?:Weekly\\s+)?Highlights\\s*/i,'');renderSection('outHighlights',h);renderSection('outChallenges',c);renderSection('outNextWeek',n)}
    function renderSection(id,txt){const c=document.getElementById(id),map=new Map();if(txt)txt.split(/\\n\\s*\\n/).forEach(b=>{const l=b.split(/\\n/).map(x=>x.trim()).filter(x=>x);if(!l.length)return;let hd=l[0].replace(/[:]$/,'');const m=KNOWN_TEAMS.find(k=>k.toLowerCase()===hd.toLowerCase());if(m)hd=m;let hc='';if(l.length>1){hc='<ul>';for(let i=1;i<l.length;i++)hc+='<li>'+l[i].replace(/^[-‚Ä¢*]\\s?/,'')+'</li>';hc+='</ul>'}if(hc)map.set(hd,hc)});const all=[...new Set([...KNOWN_TEAMS,...map.keys()])].sort((a,b)=>{const ia=KNOWN_TEAMS.indexOf(a),ib=KNOWN_TEAMS.indexOf(b);if(ia!==-1&&ib!==-1)return ia-ib;if(ia!==-1)return-1;if(ib!==-1)return 1;return a.localeCompare(b)});c.innerHTML=all.map(t=>'<div class="team-block"><span class="team-name">'+t+'</span><div class="team-content">'+(map.get(t)||'<span class="empty">Nothing to report</span>')+'</div></div>').join('')}
    function renderProjects(){const s=document.getElementById('projectSection'),c=document.getElementById('projectContainer');if(!projectData.length){s.classList.add('hidden');return}s.classList.remove('hidden');c.innerHTML=projectData.map(p=>{const pct=Math.min(100,Math.round((p.done/(p.total||1))*100));let h=0;for(let i=0;i<p.name.length;i++)h=p.name.charCodeAt(i)+((h<<5)-h);return '<div class="project-card"><div class="proj-title">'+p.name+'</div><div class="pie-chart" style="background:conic-gradient('+COLORS[Math.abs(h)%COLORS.length]+' '+pct+'%,var(--pie-empty) 0)"><span class="pie-text">'+pct+'%</span></div><div class="proj-meta">'+p.done+' / '+p.total+' '+p.desc+'</div></div>'}).join('')}
    function setMetric(m,b){currentMetric=m;document.querySelectorAll('.toggle-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');renderChart()}
    function renderChart(){const c=document.getElementById('chartContainer'),l=document.getElementById('legendContainer'),dates=[...new Set(appData.map(d=>d.date))],cats=[...new Set(appData.map(d=>d.category))].sort();if(!dates.length)return;const cc={};cats.forEach((t,i)=>cc[t]=COLORS[i%COLORS.length]);l.innerHTML=cats.map(t=>'<div class="legend-item"><div class="legend-color" style="background:'+cc[t]+'"></div>'+t+'</div>').join('');let max=0;const dt={};dates.forEach(d=>{const day=appData.filter(x=>x.date===d);let sum=0;const stk=cats.map(cat=>{const r=day.find(x=>x.category===cat);let v=0;if(r)v=(currentMetric==='total')?r.incidents+r.requests:r[currentMetric];sum+=v;return{cat,v}});dt[d]={sum,stk};if(sum>max)max=sum});max=max*1.1||10;c.innerHTML='';dates.forEach(d=>{const col=document.createElement('div');col.className='day-column';col.setAttribute('data-tooltip',d+': '+dt[d].sum);dt[d].stk.forEach(s=>{if(s.v>0){const div=document.createElement('div');div.className='stack-segment';div.style.backgroundColor=cc[s.cat];div.style.height=(s.v/max*100)+'%';col.appendChild(div)}});const lbl=document.createElement('div');lbl.className='date-label';lbl.textContent=d.split('-').slice(1).reverse().join('-');col.appendChild(lbl);c.appendChild(col)})}
    parseAndRender(rawReport);renderProjects();renderChart();
    <\/script></body></html>`;
        const blob=new Blob([snapshotHtml],{type:'text/html'}),link=document.createElement('a');link.href=URL.createObjectURL(blob);const dateName=title.replace(/[^a-zA-Z0-9-]/g,'_');link.download='Ops_Report_'+dateName+'.html';link.click();}

    // --- TEXT PARSING LOGIC (Same as before) ---
    function parseAndRender(rawText) {
        if (!rawText) return;
        const challengeRegex = /(?:\n|^)\s*(?:Challenges|Issues|Blockers)\s*(?:\n|$)/i;
        const nextWeekRegex = /(?:\n|^)\s*(?:Coming\s+)?Next\s+Week\s*(?:\n|$)/i;
        let h="",c="",n="",ci,ni;
        const cm=rawText.match(challengeRegex), nm=rawText.match(nextWeekRegex);
        ci=cm?cm.index:-1; ni=nm?nm.index:-1;
        if (ci===-1&&ni===-1) h=rawText;
        else if (ci!==-1&&ni===-1) {h=rawText.substring(0,ci);c=rawText.substring(ci+cm[0].length)}
        else if (ci===-1&&ni!==-1) {h=rawText.substring(0,ni);n=rawText.substring(ni+nm[0].length)}
        else {if(ci<ni){h=rawText.substring(0,ci);c=rawText.substring(ci+cm[0].length,ni);n=rawText.substring(ni+nm[0].length)}else{h=rawText.substring(0,ni);n=rawText.substring(ni+nm[0].length,ci);c=rawText.substring(ci+cm[0].length)}}
        h=h.replace(/^(?:Weekly\s+)?Highlights\s*/i,'');
        renderSection('outHighlights',h); renderSection('outChallenges',c); renderSection('outNextWeek',n);
    }

    function renderSection(id,text){
        const c=document.getElementById(id),map=new Map();
        if(text)text.split(/\n\s*\n/).forEach(b=>{
            const l=b.split(/\n/).map(x=>x.trim()).filter(x=>x);
            if(!l.length)return;
            let hd=l[0].replace(/[:]$/,'');
            const m=KNOWN_TEAMS.find(k=>k.toLowerCase()===hd.toLowerCase());
            if(m)hd=m;
            let hc='';
            if(l.length>1){hc='<ul>';for(let i=1;i<l.length;i++)hc+=`<li>${l[i].replace(/^[-‚Ä¢*]\s?/,'')}</li>`;hc+='</ul>'}
            if(hc)map.set(hd,hc);
        });
        const all=[...new Set([...KNOWN_TEAMS,...map.keys()])].sort((a,b)=>{const ia=KNOWN_TEAMS.indexOf(a),ib=KNOWN_TEAMS.indexOf(b);if(ia!==-1&&ib!==-1)return ia-ib;if(ia!==-1)return-1;if(ib!==-1)return 1;return a.localeCompare(b)});
        c.innerHTML=all.map(t=>`<div class="team-block"><span class="team-name">${t}</span><div class="team-content">${map.get(t)||'<span class="empty">Nothing to report</span>'}</div></div>`).join('');
    }

    // --- CHART LOGIC ---
    function setMetric(m,b){currentMetric=m;document.querySelectorAll('.toggle-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');renderChart()}
    function processData(){
        const v=document.getElementById('inputData').value;if(!v.trim())return;
        v.split(/\r?\n/).forEach(l=>{if(!l.trim()||l.toLowerCase().startsWith('datestamp'))return;const p=l.split(',');if(p.length>=4){const r={date:p[0].trim(),category:p[1].trim(),incidents:parseInt(p[2])||0,requests:parseInt(p[3])||0};appData=appData.filter(d=>!(d.date===r.date&&d.category===r.category));appData.push(r)}});
        appData.sort((a,b)=>new Date(a.date)-new Date(b.date)||a.category.localeCompare(b.category));
        localStorage.setItem(KEY_DATA,JSON.stringify(appData));renderChart();document.getElementById('inputData').value='';
    }
    function loadData(){const s=localStorage.getItem(KEY_DATA);if(s)appData=JSON.parse(s)}
    function renderChart(){
        const c=document.getElementById('chartContainer'),l=document.getElementById('legendContainer'),d=[...new Set(appData.map(x=>x.date))],t=[...new Set(appData.map(x=>x.category))].sort();
        if(!d.length)return;
        const cc={};t.forEach((x,i)=>cc[x]=COLORS[i%COLORS.length]);
        l.innerHTML=t.map(x=>`<div class="legend-item"><div class="legend-color" style="background:${cc[x]}"></div>${x}</div>`).join('');
        let max=0;const dt={};
        d.forEach(date=>{const day=appData.filter(x=>x.date===date);let s=0;const stk=t.map(cat=>{const r=day.find(x=>x.category===cat);let v=0;if(r)v=(currentMetric==='total')?r.incidents+r.requests:r[currentMetric];s+=v;return{cat,v}});dt[date]={s,stk};if(s>max)max=s});
        max=max*1.1||10;c.innerHTML='';
        d.forEach(date=>{
            const col=document.createElement('div');col.className='day-column';col.setAttribute('data-tooltip',`${formatDate(date)}: ${dt[date].s} Total`);
            dt[date].stk.forEach(s=>{if(s.v>0){const div=document.createElement('div');div.className='stack-segment';div.style.backgroundColor=cc[s.cat];div.style.height=`${(s.v/max)*100}%`;col.appendChild(div)}});
            const lbl=document.createElement('div');lbl.className='date-label';lbl.textContent=formatDate(date);col.appendChild(lbl);c.appendChild(col);
        });
    }
    function formatDate(s){const p=s.split('-');if(p.length!==3)return s;const d=new Date(parseInt(p[0]),parseInt(p[1])-1,parseInt(p[2]));return `${p[2]}-${d.toLocaleString('en-US',{month:'short'})}`}
    function clearAll(){if(confirm("Reset all?")){localStorage.clear();location.reload()}}
    function exportData(){let c="Datestamp,Category,Incidents,Requests\n";appData.forEach(r=>c+=`${r.date},${r.category},${r.incidents},${r.requests}\n`);const l=document.createElement("a");l.href='data:text/csv;charset=utf-8,'+encodeURI(c);l.download='ops_data.csv';l.click()}
</script>
</body>
</html>