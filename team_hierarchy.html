<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Org Viewer</title>
    <style>
        :root {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --card-bg: #1e1e1e;
            --card-border: #333;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #3498db;
            --hover-bg: #252525;
            --input-bg: #2d2d2d;
            --input-border: #444;
            --line-color: #444;
            --h-0: #3498db; --h-1: #9b59b6; --h-2: #e67e22; 
            --h-3: #2ecc71; --h-4: #e74c3c; --h-5: #f1c40f;
        }

        body.light-theme {
            --bg-color: #f4f4f4;
            --sidebar-bg: #e0e0e0;
            --card-bg: #ffffff;
            --card-border: #d0d0d0;
            --text-main: #333333;
            --text-muted: #666666;
            --accent: #2980b9;
            --hover-bg: #f9f9f9;
            --input-bg: #ffffff;
            --input-border: #bdc3c7;
            --line-color: #cccccc;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh; /* FIX: Fixed height for the viewport */
            overflow: hidden; /* FIX: Prevent body from scrolling */
        }

        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--card-border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }

        /* FIX: Scrolling Container */
        .main-content { 
            flex: 1; 
            padding: 40px; 
            overflow-x: auto;
            overflow-y: auto; /* FIX: Vertical scroll enabled here */
            height: 100%;
            position: relative;
        }

        .main-tree {
            min-height: 100%;
            display: inline-block; /* Allows horizontal scroll to fit width */
        }

        ul { list-style: none; padding-left: 20px; margin: 0; position: relative; }
        ul.children-list { border-left: 2px solid var(--line-color); margin-left: 15px; padding-left: 30px; }
        ul.children-list.hidden { display: none; }
        
        li { margin: 15px 0; position: relative; }
        li::before {
            content: ''; position: absolute; top: 32px; left: -32px;
            width: 30px; height: 2px; background-color: var(--line-color);
        }
        .main-tree > ul > li::before { display: none; }

        .node-card {
            display: flex; align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 12px 15px;
            border-radius: 6px;
            width: fit-content; min-width: 400px;
            cursor: grab;
            transition: all 0.2s ease;
            position: relative;
            border-left: 5px solid var(--accent);
        }
        .node-card:active { cursor: grabbing; }
        .node-card:hover { border-color: var(--accent); background-color: var(--hover-bg); }
        .node-card.drag-over { border: 2px dashed #27ae60; background: rgba(39, 174, 96, 0.1); }
        .node-card.is-dragging { opacity: 0.4; }

        /* Node Actions */
        .node-actions {
            position: absolute; top: -10px; right: 10px;
            display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s;
        }
        .node-card:hover .node-actions { opacity: 1; }
        .node-action-btn {
            width: 26px; height: 26px; border-radius: 50%; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: white;
        }
        .btn-add-child { background: #27ae60; }
        .btn-del-node { background: #c0392b; }

        /* Existing UI Components */
        .info { display: flex; flex-direction: column; width: 100%; }
        .name { font-weight: bold; font-size: 16px; }
        .role { font-size: 12px; color: var(--text-muted); text-transform: uppercase; }
        .pill { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; margin-right: 4px; }
        .toggle-btn { margin-right: 10px; cursor: pointer; border: 1px solid var(--input-border); width: 20px; text-align: center; }
        
        /* Modal & Toasts */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--sidebar-bg); padding: 20px; border-radius: 8px; width: 400px; }
        .toast-container { position: fixed; bottom: 20px; right: 20px; }
        .toast { background: #333; color: #fff; padding: 10px 20px; border-radius: 4px; margin-top: 5px; }
    </style>
</head>
<body>

<aside class="sidebar">
    <h3 id="displayTitle">Org Viewer</h3>
    <input type="text" id="searchInput" placeholder="Search..." oninput="applyFilter()">
    <hr>
    <button onclick="expandAll()">Expand All</button>
    <button onclick="collapseAll()" style="margin-top:5px">Collapse All</button>
</aside>

<main class="main-content">
    <div id="tree-container" class="main-tree"></div>
</main>

<div class="modal-overlay" id="editModal">
    <div class="modal">
        <h3>Edit Details</h3>
        <input type="hidden" id="editNodeId">
        <label>Name</label><br>
        <input type="text" id="editName" style="width:100%"><br><br>
        <button onclick="saveNodeChanges()">Save</button>
        <button onclick="closeModal()">Cancel</button>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
    let appData = {
        tree: {
            id: "root-1",
            name: "Sarah Connors",
            role: "CEO",
            children: [
                { id: "c1", name: "John Reese", role: "CTO", children: [] },
                { id: "c2", name: "Samantha Root", role: "VP Sales", children: [] }
            ]
        }
    };

    // --- UTILITIES ---
    function findNodeAndParent(id, currentNode, parent = null) {
        if (currentNode.id === id) return { node: currentNode, parent: parent };
        if (currentNode.children) {
            for (let child of currentNode.children) {
                const result = findNodeAndParent(id, child, currentNode);
                if (result) return result;
            }
        }
        return null;
    }

    function isDescendant(sourceId, targetId) {
        const sourceRes = findNodeAndParent(sourceId, appData.tree);
        if (!sourceRes) return false;
        function check(node) {
            if (node.id === targetId) return true;
            return node.children.some(child => check(child));
        }
        return check(sourceRes.node);
    }

    // --- CORE RENDERING ---
    function renderTree() {
        const container = document.getElementById('tree-container');
        container.innerHTML = '';
        const rootUl = document.createElement('ul');
        container.appendChild(rootUl);
        buildNode(appData.tree, rootUl, 0);
    }

    function buildNode(data, parentElement, depth) {
        const li = document.createElement('li');
        li.dataset.id = data.id;

        const card = document.createElement('div');
        card.className = 'node-card';
        card.draggable = true;
        card.dataset.nodeId = data.id;
        card.style.borderLeftColor = `var(--h-${depth % 6})`;

        // FIX: Re-attach Drag & Drop Listeners every render
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('dragleave', handleDragLeave);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragend', handleDragEnd);

        // Content
        card.innerHTML = `
            <div class="info">
                <span class="name">${data.name}</span>
                <span class="role">${data.role}</span>
            </div>
            <div class="node-actions">
                <button class="node-action-btn btn-add-child" onclick="addChild('${data.id}', event)">+</button>
                <button class="node-action-btn btn-del-node" onclick="deleteNode('${data.id}', event)">Ã—</button>
            </div>
        `;

        card.onclick = () => openEditModal(data.id);
        li.appendChild(card);

        if (data.children && data.children.length > 0) {
            const childUl = document.createElement('ul');
            childUl.className = 'children-list';
            data.children.forEach(child => buildNode(child, childUl, depth + 1));
            li.appendChild(childUl);
        }

        parentElement.appendChild(li);
    }

    // --- DRAG & DROP LOGIC ---
    let draggedNodeId = null;

    function handleDragStart(e) {
        draggedNodeId = this.dataset.nodeId;
        this.classList.add('is-dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
        e.preventDefault();
        const targetId = this.dataset.nodeId;
        if (draggedNodeId === targetId || isDescendant(draggedNodeId, targetId)) {
            return;
        }
        this.classList.add('drag-over');
    }

    function handleDragLeave() { this.classList.remove('drag-over'); }

    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        const targetId = this.dataset.nodeId;

        if (draggedNodeId === targetId || isDescendant(draggedNodeId, targetId)) return;

        const sourceRes = findNodeAndParent(draggedNodeId, appData.tree);
        const targetRes = findNodeAndParent(targetId, appData.tree);

        if (sourceRes && targetRes) {
            // Remove from old parent
            if (sourceRes.parent) {
                sourceRes.parent.children = sourceRes.parent.children.filter(c => c.id !== draggedNodeId);
            }
            // Add to new parent
            targetRes.node.children.push(sourceRes.node);
            renderTree();
        }
    }

    function handleDragEnd() { this.classList.remove('is-dragging'); }

    // --- ADD / DELETE ---
    function addChild(parentId, event) {
        event.stopPropagation();
        const res = findNodeAndParent(parentId, appData.tree);
        if (res) {
            const newId = "node-" + Date.now();
            res.node.children.push({ id: newId, name: "New Person", role: "Role", children: [] });
            renderTree();
        }
    }

    function deleteNode(id, event) {
        event.stopPropagation();
        const res = findNodeAndParent(id, appData.tree);
        if (res && res.parent) {
            if (confirm("Delete this node?")) {
                res.parent.children = res.parent.children.filter(c => c.id !== id);
                renderTree();
            }
        } else {
            alert("Cannot delete root node");
        }
    }

    // --- UI HELPERS ---
    function expandAll() { document.querySelectorAll('.children-list').forEach(el => el.classList.remove('hidden')); }
    function collapseAll() { document.querySelectorAll('.children-list').forEach(el => el.classList.add('hidden')); }
    
    function openEditModal(id) {
        const res = findNodeAndParent(id, appData.tree);
        document.getElementById('editNodeId').value = id;
        document.getElementById('editName').value = res.node.name;
        document.getElementById('editModal').classList.add('active');
    }
    
    function closeModal() { document.getElementById('editModal').classList.remove('active'); }
    
    function saveNodeChanges() {
        const id = document.getElementById('editNodeId').value;
        const name = document.getElementById('editName').value;
        const res = findNodeAndParent(id, appData.tree);
        if (res) {
            res.node.name = name;
            renderTree();
            closeModal();
        }
    }

    renderTree();
</script>
</body>
</html>
