<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Org Viewer</title>
    <style>
        /* ==========================================================
           1) THEME VARIABLES
           ========================================================== */
        :root {
            /* DARK THEME (Default) */
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --card-bg: #1e1e1e;
            --card-border: #333;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #3498db;
            --hover-bg: #252525;
            --input-bg: #2d2d2d;
            --input-border: #444;
            --line-color: #444;
            
            /* Hierarchy Colors */
            --h-0: #3498db; /* Blue */
            --h-1: #9b59b6; /* Purple */
            --h-2: #e67e22; /* Orange */
            --h-3: #2ecc71; /* Green */
            --h-4: #e74c3c; /* Red */
            --h-5: #f1c40f; /* Yellow */
        }

        /* LIGHT THEME Override */
        body.light-theme {
            --bg-color: #f4f4f4;
            --sidebar-bg: #e0e0e0;
            --card-bg: #ffffff;
            --card-border: #d0d0d0;
            --text-main: #333333;
            --text-muted: #666666;
            --accent: #2980b9;
            --hover-bg: #f9f9f9;
            --input-bg: #ffffff;
            --input-border: #bdc3c7;
            --line-color: #cccccc;
        }

        /* ==========================================================
           2) PAGE LAYOUT
           ========================================================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            min-height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--card-border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            flex-shrink: 0;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .sidebar-logo {
            width: 100%; height: auto; margin-bottom: 15px; border-radius: 4px; display: block;
        }

        /* Theme Toggle with Icons */
        .theme-toggle-wrapper {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 15px; padding-bottom: 15px;
            border-bottom: 1px solid var(--card-border);
        }
        .theme-label { font-size: 13px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); }
        .theme-btn {
            background: none; border: none; cursor: pointer; color: var(--text-main);
            display: flex; align-items: center; justify-content: center;
            padding: 5px; border-radius: 50%; transition: background 0.2s;
        }
        .theme-btn:hover { background: var(--hover-bg); }
        .theme-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .hidden { display: none !important; }

        /* Editable Title Input */
        .app-title-input {
            font-size: 18px; font-weight: bold; color: var(--text-main);
            background-color: transparent !important; /* FIXED: Strict transparency */
            border: 1px solid transparent;
            padding: 4px 0; width: 100%; margin-bottom: 20px; border-radius: 4px;
        }
        /* Ensure no background appears on hover or focus */
        .app-title-input:hover, .app-title-input:focus {
            background-color: transparent !important;
            border-color: transparent; /* No border on hover */
            outline: none;
        }

        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; text-transform: uppercase; }

        select, input[type="text"] {
            width: 100%; padding: 10px; background: var(--input-bg); color: var(--text-main);
            border: 1px solid var(--input-border); border-radius: 4px;
            outline: none; cursor: pointer; box-sizing: border-box;
        }
        select:focus, input[type="text"]:focus { border-color: var(--accent); }
        #searchInput { background-color: var(--input-bg); border: 1px solid var(--input-border); }

        .btn-group { display: flex; flex-direction: column; gap: 10px; }
        button {
            padding: 10px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: 600; font-size: 13px;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-success { background-color: #27ae60; color: white; }
        .btn-success:hover { opacity: 0.9; }
        .btn-danger { background-color: #c0392b; color: white; }
        .btn-danger:hover { opacity: 0.9; }

        .toggle-wrapper {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--input-bg); padding: 10px; border-radius: 4px; border: 1px solid var(--input-border);
        }
        .toggle-wrapper label { margin: 0; cursor: pointer; }

        /* Floating Toolbar */
        .floating-toolbar {
            position: fixed; top: 20px; right: 20px;
            display: flex; gap: 10px; z-index: 500;
        }
        .icon-btn {
            width: 44px; height: 44px; border-radius: 50%;
            background: var(--card-bg); border: 1px solid var(--card-border);
            color: var(--text-main); 
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .icon-btn:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-2px); }
        .icon-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* Main content - FIXED SCROLL */
        .main-content { 
            flex: 1; 
            padding: 40px; 
            overflow-x: hidden;
            overflow-y: auto; /* Explicit scroll */
            height: 100%;
            position: relative;
        }

        /* ==========================================================
           3) TREE LINES
           ========================================================== */
        ul { list-style: none; padding-left: 20px; margin: 0; position: relative; }
        ul.children-list {
            border-left: 2px solid var(--line-color);
            margin-left: 15px; padding-left: 30px;
        }
        li { margin: 15px 0; position: relative; }
        li::before {
            content: ''; position: absolute; top: 32px; left: -32px;
            width: 30px; height: 2px; background-color: var(--line-color);
        }
        .main-tree > ul > li::before { display: none; }
        .main-tree > ul > li > ul.children-list { margin-left: 25px; }

        /* ==========================================================
           4) NODE CARD
           ========================================================== */
        .node-card {
            display: flex; align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 12px 15px;
            border-radius: 6px;
            width: fit-content; min-width: 450px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            user-select: none;
            border-left-width: 5px; 
        }
        .node-card:hover {
            border-color: var(--accent);
            background-color: var(--hover-bg);
            transform: translateX(5px);
        }

        /* Node Actions (Add/Delete) */
        .node-actions {
            position: absolute; top: -10px; right: 10px;
            display: flex; gap: 5px;
            opacity: 0; transition: opacity 0.2s;
            z-index: 10;
        }
        .node-card:hover .node-actions { opacity: 1; }
        
        .node-action-btn {
            width: 26px; height: 26px; border-radius: 50%;
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10; 
            padding: 0;
            touch-action: manipulation;
            /* Prevent button itself from being draggable */
            -webkit-user-drag: none;
            user-drag: none;
        }
        .node-action-btn svg { width: 14px; height: 14px; fill: white; pointer-events: none; }
        .btn-add-child { background-color: #27ae60; }
        .btn-add-child:hover { background-color: #219150; }
        .btn-del-node { background-color: #c0392b; }
        .btn-del-node:hover { background-color: #a93226; }

        /* Drag and Drop Visuals */
        .node-card.drag-over { border: 2px dashed #27ae60; background-color: rgba(39, 174, 96, 0.1); }
        .node-card.is-dragging { opacity: 0.5; }
        .node-card.matched { border: 1px solid #27ae60; box-shadow: 0 0 10px rgba(39, 174, 96, 0.2); }
        .node-card.matched .name { color: #27ae60; }

        /* ==========================================================
           5) TEXT & PILLS
           ========================================================== */
        .info { display: flex; flex-direction: column; width: 100%; }
        .top-row { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
        .name { font-weight: 700; font-size: 16px; color: var(--text-main); pointer-events: none; }

        .engagement-pill {
            font-size: 11px; color: var(--accent); border: 1px solid var(--accent);
            padding: 1px 6px; border-radius: 10px; text-transform: uppercase; font-weight: 600; pointer-events: none;
        }
        .location-pill {
            font-size: 11px; color: #2ecc71; border: 1px solid #2ecc71;
            padding: 1px 6px; border-radius: 10px; text-transform: uppercase; font-weight: 600; pointer-events: none;
        }

        .role { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
        .tags-row { display: flex; flex-wrap: wrap; gap: 6px; transition: opacity 0.3s; }
        .hide-tags .tags-row { display: none; }
        .hide-tags .role { margin-bottom: 0; }

        .pill {
            display: inline-block; padding: 3px 8px; border-radius: 4px;
            font-size: 10px; font-weight: 700; color: white;
            text-transform: uppercase; letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        .toggle-btn {
            margin-right: 15px; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--input-border); border-radius: 4px;
            background: var(--input-bg); color: var(--text-muted);
            font-size: 16px; font-weight: bold; flex-shrink: 0;
            -webkit-user-drag: none;
            user-drag: none;
        }
        .toggle-btn:hover { border-color: var(--accent); color: var(--accent); }

        .hidden-node { display: none !important; }

        /* Tooltip */
        .tooltip {
            visibility: hidden; width: 250px; background-color: #000; color: #fff; border: 1px solid #333;
            padding: 10px; border-radius: 4px; position: absolute; z-index: 100;
            top: 50%; left: 100%; margin-left: 15px; transform: translateY(-50%);
            font-size: 12px; line-height: 1.4; opacity: 0; transition: opacity 0.3s; pointer-events: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        body.light-theme .tooltip { border: 1px solid #ccc; background: #333; }
        .node-card:hover .tooltip { visibility: visible; opacity: 1; }

        /* ==========================================================
           6) EDITOR MODAL
           ========================================================== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal {
            background: var(--sidebar-bg); width: 500px; border-radius: 8px;
            border: 1px solid var(--card-border); box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; max-height: 90vh;
        }
        .modal-header {
            padding: 15px 20px; border-bottom: 1px solid var(--card-border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { margin: 0; font-size: 18px; }
        .close-modal { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; padding: 0; }
        .close-modal:hover { color: var(--text-main); }
        .modal-body { padding: 20px; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 5px; }
        .form-group input, .form-group textarea {
            width: 100%; background: #121212; border: 1px solid var(--input-border); color: var(--text-main);
            padding: 8px; border-radius: 4px; box-sizing: border-box;
        }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--accent); outline: none; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--card-border); display: flex; justify-content: flex-end; gap: 10px; }

        body.light-theme .form-group input, body.light-theme .form-group textarea { background: #fff; }

        /* ==========================================================
           7) TOAST NOTIFICATION
           ========================================================== */
        .toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 3000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background: #333; color: white; padding: 12px 20px;
            border-radius: 4px; border-left: 4px solid var(--accent);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-size: 14px;
            animation: slideIn 0.3s ease-out forwards;
            opacity: 0; transform: translateY(20px);
            max-width: 350px;
        }
        .toast.success { border-left-color: #27ae60; }
        .toast.error { border-left-color: #e74c3c; }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-10px); } }

    </style>
</head>
<body>

<aside class="sidebar">
    <img src="https://via.placeholder.com/280x100.png?text=Company+Logo" alt="Company Logo" class="sidebar-logo">

    <input type="text" id="appTitle" class="app-title-input" value="Org Viewer" oninput="updateTitle(this.value)">

    <div class="control-group">
        <label>Search</label>
        <input type="text" id="searchInput" placeholder="Name, Role, Loc, Tag..." oninput="applyFilter()">
    </div>

    <div class="control-group">
        <label>Filter by Role</label>
        <select id="roleFilter" onchange="applyFilter()">
            <option value="ALL">Show All</option>
        </select>
    </div>

    <div class="control-group">
        <label>Filter by Location</label>
        <select id="locFilter" onchange="applyFilter()">
            <option value="ALL">Show All</option>
        </select>
    </div>

    <div class="control-group">
        <label>Filter by Tag</label>
        <select id="tagFilter" multiple size="6" onchange="applyFilter()"></select>
        <div style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">Hold <strong>Ctrl</strong> to select multiple.</div>
    </div>

    <div class="control-group">
        <label>View Options</label>
        <div class="toggle-wrapper">
            <span style="font-size: 13px;">Show Tags</span>
            <input type="checkbox" id="toggleTagsCheck" checked onchange="toggleTags()">
        </div>
        <div style="height: 10px;"></div>
        <button class="btn-danger" style="width: 100%" onclick="resetAll()">Reset Filtering</button>
    </div>

    <!-- THEME TOGGLE MOVED HERE -->
    <div class="theme-toggle-wrapper">
        <span class="theme-label">Theme</span>
        <button class="theme-btn" onclick="toggleTheme()" title="Toggle Theme">
            <!-- Sun Icon (Default Dark Mode -> Light Action) -->
            <svg id="sunIcon" class="hidden" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></svg>
            <!-- Moon Icon (Hidden initially) -->
            <svg id="moonIcon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
        </button>
    </div>

    <div class="control-group" style="margin-top: auto;">
        <label>Data Management</label>
        <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="importJson(this)">
        <div class="btn-group">
            <button class="btn-success" onclick="triggerUpload()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Load JSON
            </button>
            <button class="btn-primary" onclick="saveJson()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Download JSON
            </button>
        </div>
    </div>
</aside>

<div class="floating-toolbar">
    <button class="icon-btn" title="Expand All" onclick="expandAll()">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </button>
    <button class="icon-btn" title="Collapse All" onclick="collapseAll()">
        <svg viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg>
    </button>
</div>

<div class="main-content">
    <div id="tree-container" class="main-tree"></div>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-header">
            <h2>Edit Person Details</h2>
            <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editNodeId">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>Role</label>
                <input type="text" id="editRole">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="editLocation">
            </div>
            <div class="form-group">
                <label>Engagement</label>
                <input type="text" id="editEngagement">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="editDesc"></textarea>
            </div>
            <div class="form-group">
                <label>Tags (Comma separated)</label>
                <input type="text" id="editTags" placeholder="e.g. Python, Agile, Lead">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn-primary" onclick="saveNodeChanges()">Save Changes</button>
        </div>
    </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<script>
    // ==========================================================
    // 1) STATE & DATA MANAGEMENT
    // ==========================================================
    let appData = {
        title: "Org Viewer",
        tree: {
            id: "root-1",
            name: "Sarah Connors",
            role: "CEO",
            location: "New York",
            engagement: "Internal",
            description: "Head of entire organization.",
            tags: ["Leadership", "Strategy"],
            children: [
                {
                    id: "c1",
                    name: "John Reese",
                    role: "CTO",
                    location: "San Francisco",
                    engagement: "Internal",
                    description: "Overseeing all tech stacks.",
                    tags: ["Architecture", "Cloud"],
                    children: [
                        {
                            id: "c1-1",
                            name: "Harold Finch",
                            role: "Lead AI Engineer",
                            location: "New York",
                            engagement: "Internal",
                            description: "Building machine.",
                            tags: ["AI", "Python", "Algorithms"],
                            children: [
                                {
                                    id: "c1-1-1",
                                    name: "Sameen Shaw",
                                    role: "Security Analyst",
                                    location: "Remote",
                                    engagement: "Internal",
                                    description: "Root access and permissions.",
                                    tags: ["Security", "Ops"],
                                    children: []
                                }
                            ]
                        }
                    ]
                },
                {
                    id: "c2",
                    name: "Samantha Root",
                    role: "VP of Sales",
                    location: "London",
                    engagement: "Kingfisher",
                    description: "Managing global sales accounts.",
                    tags: ["Sales", "CRM"],
                    children: [
                        {
                            id: "c2-1",
                            name: "Lionel Fusco",
                            role: "Sales Manager",
                            location: "London",
                            engagement: "TCS",
                            description: "Direct reports handling.",
                            tags: ["Management", "Support"],
                            children: []
                        }
                    ]
                }
            ]
        }
    };

    function ensureIds(node) {
        if (!node.id) node.id = 'node-' + Math.random().toString(36).substr(2, 9);
        if (node.children) node.children.forEach(ensureIds);
        return node;
    }
    ensureIds(appData.tree);

    function updateTitle(newTitle) {
        appData.title = newTitle || "Org Viewer";
        document.title = newTitle;
    }
    document.getElementById('appTitle').value = appData.title;

    function toggleTheme() {
        document.body.classList.toggle('light-theme');
        const isLight = document.body.classList.contains('light-theme');
        
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        
        if (isLight) {
            // LIGHT MODE: Show Sunshine (Sun) Icon
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
            showToast('Switched to Light theme', 'info');
        } else {
            // DARK MODE: Show Moon Icon
            sunIcon.classList.add('hidden');
            moonIcon.classList.remove('hidden');
            showToast('Switched to Dark theme', 'info');
        }
    }

    function triggerUpload() { document.getElementById('jsonFileInput').click(); }

    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const h = Math.abs(hash) % 360;
        return `hsl(${h}, 65%, 40%)`;
    }

    function findNodeAndParent(id, currentNode, parent = null) {
        if (currentNode.id === id) return { node: currentNode, parent: parent };
        if (currentNode.children) {
            for (let child of currentNode.children) {
                const result = findNodeAndParent(id, child, currentNode);
                if (result) return result;
            }
        }
        return null;
    }

    function isDescendant(sourceId, targetId) {
        const sourceRes = findNodeAndParent(sourceId, appData.tree);
        if (!sourceRes) return false;
        function check(node) {
            if (node.id === targetId) return true;
            if (node.children) {
                for (let child of node.children) {
                    if (check(child)) return true;
                }
            }
            return false;
        }
        return check(sourceRes.node);
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s ease-out forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ==========================================================
    // 2) RENDER TREE
    // ==========================================================
    const container = document.getElementById('tree-container');

    function renderTree() {
        container.innerHTML = '';
        const rootUl = document.createElement('ul');
        container.appendChild(rootUl);
        buildNode(appData.tree, rootUl, 0);
        populateDropdowns();
        applyFilter();
    }

    function buildNode(data, parentElement, depth) {
        const li = document.createElement('li');
        li.className = "tree-item";
        li.dataset.id = data.id;

        const rawTags = Array.isArray(data.tags) ? data.tags.slice() : [];
        rawTags.sort((a, b) => a.localeCompare(b));

        const engagement = data.engagement || "";
        const rawLoc = data.location || "";
        const locLabel = rawLoc || "Unknown";
        const roleLabel = data.role || "Unknown";

        const upperTags = rawTags.map(t => t.toUpperCase());
        const tagTokens = new Set(upperTags);
        if (locLabel) tagTokens.add(locLabel.toUpperCase());
        if (engagement) tagTokens.add(String(engagement).toUpperCase());

        li.dataset.tags = Array.from(tagTokens).join(',');
        li.dataset.location = locLabel.toUpperCase();
        li.dataset.role = roleLabel.toUpperCase();

        const searchTextParts = [
            data.name, data.role, data.location, data.description, ...rawTags
        ].join(" ");
        li.dataset.searchText = searchTextParts.toUpperCase();

        const hasChildren = Array.isArray(data.children) && data.children.length > 0;
        const card = document.createElement('div');
        card.className = hasChildren ? 'node-card has-children' : 'node-card';
        
        const colorIndex = depth % 6;
        const hierarchyColor = getComputedStyle(document.body).getPropertyValue(`--h-${colorIndex}`).trim();
        card.style.borderLeftColor = hierarchyColor;

        card.draggable = true;
        card.dataset.nodeId = data.id;

        // --- NODE ACTIONS (FIXED) ---
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'node-actions';
        
        // Add Button
        const addBtn = document.createElement('button');
        addBtn.className = 'node-action-btn btn-add-child';
        addBtn.draggable = false; // Prevent button from being draggable
        addBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>';
        addBtn.title = "Add Child";
        addBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevents card click
            addChildNode(data.id);
        });

        // Delete Button
        const delBtn = document.createElement('button');
        delBtn.className = 'node-action-btn btn-del-node';
        delBtn.draggable = false; // Prevent button from being draggable
        delBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>';
        delBtn.title = "Delete Node";
        delBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevents card click
            deleteNode(data.id);
        });

        actionsDiv.appendChild(addBtn);
        actionsDiv.appendChild(delBtn);
        card.appendChild(actionsDiv);

        // --- TOGGLE BUTTON ---
        let toggleBtnDiv = null;
        if (hasChildren) {
            toggleBtnDiv = document.createElement('div');
            toggleBtnDiv.className = 'toggle-btn';
            toggleBtnDiv.draggable = false; // Not draggable
            toggleBtnDiv.textContent = "−";
            // Click handling handled by card listener below via class check
        } else {
            const spacer = document.createElement('div');
            spacer.style.cssText = "width:24px; margin-right:15px;";
            card.appendChild(spacer);
        }

        if (toggleBtnDiv) card.appendChild(toggleBtnDiv);

        // --- CONTENT ---
        let pillsHtml = "";
        rawTags.forEach(tag => {
            const color = stringToColor(tag);
            pillsHtml += `<span class="pill" style="background-color: ${color}">${tag}</span>`;
        });

        const engagementHtml = engagement ? `<span class="engagement-pill">${engagement}</span>` : '';
        const locationHtml = rawLoc ? `<span class="location-pill">${rawLoc}</span>` : '';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'info';
        contentDiv.innerHTML = `
            <div class="top-row">
                <span class="name">${data.name}</span>
                ${engagementHtml}
                ${locationHtml}
            </div>
            <span class="role">${roleLabel}</span>
            <div class="tags-row">
                ${pillsHtml}
            </div>
        `;
        
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.textContent = data.description || "";
        card.appendChild(contentDiv);
        card.appendChild(tooltip);

        // --- CONSOLIDATED CLICK HANDLER ---
        // This handles Modal Open and Tree Toggle
        card.addEventListener('click', (e) => {
            // If clicked Action Buttons (handled by listeners above), stop propagation
            if (e.target.closest('.node-action-btn')) return;

            // If clicked Toggle Button
            if (e.target.closest('.toggle-btn') && childUl) {
                e.stopPropagation();
                const isHidden = childUl.classList.contains('hidden');
                childUl.classList.toggle('hidden');
                if (toggleBtnDiv) toggleBtnDiv.textContent = isHidden ? "−" : "+";
                return;
            }

            // Otherwise open Modal
            openEditModal(data.id);
        });

        li.appendChild(card);

        // --- CHILDREN ---
        let childUl = null;
        if (hasChildren) {
            childUl = document.createElement('ul');
            childUl.className = 'children-list';
            data.children.forEach(child => buildNode(child, childUl, depth + 1));
            li.appendChild(childUl);
        }

        parentElement.appendChild(li);
    }

    // ==========================================================
    // 3) ADD / DELETE NODE LOGIC
    // ==========================================================
    function addChildNode(parentId) {
        const res = findNodeAndParent(parentId, appData.tree);
        if (!res) return;

        const newNode = {
            id: 'node-' + Math.random().toString(36).substr(2, 9),
            name: "New Person",
            role: "New Role",
            location: "",
            engagement: "",
            description: "",
            tags: [],
            children: []
        };

        if (!res.node.children) res.node.children = [];
        res.node.children.push(newNode);

        renderTree();
        openEditModal(newNode.id);
        showToast("Added new child node", "success");
    }

    function deleteNode(nodeId) {
        const res = findNodeAndParent(nodeId, appData.tree);
        
        if (!res) {
            showToast("Error finding node.", "error");
            return;
        }

        if (!res.parent) {
            showToast("Cannot delete: root node.", "error");
            return;
        }

        if (confirm(`Are you sure you want to delete "${res.node.name}"?`)) {
            res.parent.children = res.parent.children.filter(child => child.id !== nodeId);
            renderTree();
            showToast("Node deleted successfully", "success");
        }
    }

    // ==========================================================
    // 4) EDIT MODAL LOGIC
    // ==========================================================
    const modal = document.getElementById('editModal');
    const editNodeId = document.getElementById('editNodeId');
    const editName = document.getElementById('editName');
    const editRole = document.getElementById('editRole');
    const editLocation = document.getElementById('editLocation');
    const editEngagement = document.getElementById('editEngagement');
    const editDesc = document.getElementById('editDesc');
    const editTags = document.getElementById('editTags');

    function openEditModal(id) {
        const res = findNodeAndParent(id, appData.tree);
        if (!res) return;
        const node = res.node;
        editNodeId.value = node.id;
        editName.value = node.name;
        editRole.value = node.role || "";
        editLocation.value = node.location || "";
        editEngagement.value = node.engagement || "";
        editDesc.value = node.description || "";
        editTags.value = Array.isArray(node.tags) ? node.tags.join(', ') : "";
        modal.classList.add('active');
        editName.focus();
    }

    function closeModal() {
        modal.classList.remove('active');
    }

    function saveNodeChanges() {
        const id = editNodeId.value;
        const res = findNodeAndParent(id, appData.tree);
        if (!res) return;
        const node = res.node;
        node.name = editName.value;
        node.role = editRole.value;
        node.location = editLocation.value;
        node.engagement = editEngagement.value;
        node.description = editDesc.value;
        const tagStr = editTags.value;
        node.tags = tagStr ? tagStr.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];
        renderTree();
        closeModal();
        showToast('Details updated successfully', 'success');
    }

    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    // ==========================================================
    // 5) DRAG AND DROP LOGIC
    // ==========================================================
    let draggedNodeId = null;

    function handleDragStart(e) {
        draggedNodeId = this.dataset.nodeId;
        this.classList.add('is-dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
        e.preventDefault();
        const targetId = this.dataset.nodeId;
        if (draggedNodeId === targetId || isDescendant(draggedNodeId, targetId)) {
            e.dataTransfer.dropEffect = 'none';
            return;
        }
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
    }

    function handleDragLeave(e) { this.classList.remove('drag-over'); }

    function handleDrop(e) {
        e.stopPropagation(); e.preventDefault(); this.classList.remove('drag-over');
        const targetId = this.dataset.nodeId;
        if (draggedNodeId === targetId) return;
        if (isDescendant(draggedNodeId, targetId)) {
            showToast("Cannot drop a parent into its own child.", "error");
            return;
        }
        const sourceRes = findNodeAndParent(draggedNodeId, appData.tree);
        const targetRes = findNodeAndParent(targetId, appData.tree);
        if (sourceRes && targetRes) {
            const sourceNode = sourceRes.node;
            const sourceParent = sourceRes.parent;
            const targetNode = targetRes.node;
            if (sourceParent) sourceParent.children = sourceParent.children.filter(child => child.id !== draggedNodeId);
            if (!targetNode.children) targetNode.children = [];
            targetNode.children.push(sourceNode);
            renderTree();
            showToast(`Moved ${sourceNode.name} to ${targetNode.name}`, 'success');
        }
    }

    function handleDragEnd(e) {
        this.classList.remove('is-dragging');
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        draggedNodeId = null;
    }

    // ==========================================================
    // 6) FILTERING
    // ==========================================================
    function populateDropdowns() {
        const allTags = new Set();
        const allLocs = new Set();
        const allRoles = new Set();

        function collect(node) {
            if (Array.isArray(node.tags)) node.tags.forEach(t => allTags.add(String(t).toUpperCase()));
            const l = node.location;
            if (l) { allLocs.add(String(l).toUpperCase()); allTags.add(String(l).toUpperCase()); }
            const eng = node.engagement;
            if (eng) allTags.add(String(eng).toUpperCase());
            if (node.role) allRoles.add(String(node.role).toUpperCase());
            if (Array.isArray(node.children)) node.children.forEach(collect);
        }
        collect(appData.tree);

        function fillSelect(id, set) {
            const select = document.getElementById(id);
            const currentVals = Array.from(select.selectedOptions).map(o => o.value);
            select.innerHTML = '';
            const optAll = document.createElement('option');
            optAll.value = "ALL"; optAll.textContent = "Show All"; select.appendChild(optAll);
            Array.from(set).sort().forEach(val => {
                const opt = document.createElement('option');
                opt.value = val; opt.textContent = val; select.appendChild(opt);
            });
            Array.from(select.options).forEach(opt => {
                if (currentVals.includes(opt.value)) opt.selected = true;
            });
        }
        fillSelect('tagFilter', allTags);
        fillSelect('locFilter', allLocs);
        fillSelect('roleFilter', allRoles);
    }

    function applyFilter() {
        const searchInput = document.getElementById('searchInput');
        const searchVal = (searchInput.value || "").toUpperCase();
        const tagFilterEl = document.getElementById('tagFilter');
        const selectedTags = Array.from(tagFilterEl.selectedOptions).map(o => o.value).filter(v => v !== "ALL");
        const selectedLoc = document.getElementById('locFilter').value;
        const selectedRole = document.getElementById('roleFilter').value;
        const rootLi = document.querySelector('.tree-item');
        if (!rootLi) return;

        function nodeMatches(li) {
            const fullText = (li.dataset.searchText || "");
            const searchPass = (searchVal === "") || fullText.includes(searchVal);
            const nodeTags = (li.dataset.tags || "");
            const nodeLoc = li.dataset.location || "UNKNOWN";
            const nodeRole = li.dataset.role || "UNKNOWN";
            const tagsPass = selectedTags.length === 0 || selectedTags.every(tag => nodeTags.includes(tag));
            const locPass = (selectedLoc === "ALL") || (nodeLoc === selectedLoc);
            const rolePass = (selectedRole === "ALL") || (nodeRole === selectedRole);
            return searchPass && tagsPass && locPass && rolePass;
        }

        function evaluateVisibility(li) {
            const selfMatch = nodeMatches(li);
            const card = li.querySelector('.node-card');
            let anyChildVisible = false;
            const childrenUl = li.querySelector(':scope > ul.children-list');
            
            if (childrenUl) {
                const childLis = Array.from(childrenUl.children).filter(el => el.tagName === 'LI');
                childLis.forEach(childLi => {
                    if (evaluateVisibility(childLi)) anyChildVisible = true;
                });
            }
            const isVisible = selfMatch || anyChildVisible;

            if (isVisible) {
                li.classList.remove('hidden-node');
                if (selfMatch) card.classList.add('matched');
                else card.classList.remove('matched');
                if (anyChildVisible && childrenUl) {
                    childrenUl.classList.remove('hidden');
                    const btn = card.querySelector('.toggle-btn');
                    if (btn) btn.textContent = "−";
                }
            } else {
                li.classList.add('hidden-node');
                card.classList.remove('matched');
            }
            return isVisible;
        }
        document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('hidden-node'));
        document.querySelectorAll('.node-card').forEach(el => el.classList.remove('matched'));
        evaluateVisibility(rootLi);
    }

    // ==========================================================
    // 7) UI ACTIONS
    // ==========================================================
    function expandAll() {
        document.querySelectorAll('.children-list').forEach(ul => ul.classList.remove('hidden'));
        document.querySelectorAll('.toggle-btn').forEach(btn => (btn.textContent = "−"));
    }

    function collapseAll() {
        document.querySelectorAll('.children-list').forEach(ul => ul.classList.add('hidden'));
        document.querySelectorAll('.toggle-btn').forEach(btn => (btn.textContent = "+"));
    }

    function resetAll() {
        document.getElementById('searchInput').value = "";
        document.getElementById('roleFilter').value = 'ALL';
        document.getElementById('locFilter').value = 'ALL';
        const tagFilter = document.getElementById('tagFilter');
        Array.from(tagFilter.options).forEach(opt => opt.selected = false);
        document.getElementById('toggleTagsCheck').checked = true;
        document.querySelector('.main-content').classList.remove('hide-tags');
        expandAll();
        applyFilter();
        showToast("View reset to default", "info");
    }

    function toggleTags() {
        const check = document.getElementById('toggleTagsCheck');
        const container = document.querySelector('.main-content');
        if (check.checked) container.classList.remove('hide-tags');
        else container.classList.add('hide-tags');
    }

    function saveJson() {
        const dataStr = JSON.stringify(appData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const filename = "org-data-v" + new Date().toISOString().slice(0,10) + ".json";
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        document.body.removeChild(a); URL.revokeObjectURL(url);
        showToast(`File "${filename}" downloaded successfully`, "success");
    }

    function importJson(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if (json.tree && typeof json.tree === 'object') {
                    appData.title = json.title || "Org Viewer";
                    appData.tree = json.tree;
                } else if (json.name && json.children) {
                    appData.title = "Imported Org";
                    appData.tree = json;
                } else { throw new Error("Invalid JSON structure."); }
                ensureIds(appData.tree);
                document.getElementById('appTitle').value = appData.title;
                renderTree();
                resetAll();
                showToast("Data imported successfully", "success");
            } catch (err) {
                console.error(err);
                showToast("Error importing JSON: " + err.message, "error");
            }
            input.value = '';
        };
        reader.readAsText(file);
    }

    renderTree();

</script>
</body>
</html>
