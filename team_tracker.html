<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Platforms Tracker v29</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --modal-bg: #252525;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #bb86fc;
            --accent-hover: #9965f4;
            --border: #333;

            /* Status Colors */
            --g-green: #00e676;
            --g-amber: #ffb300;
            --g-red: #ff1744;
            --g-grey: #666666;
            /* Chart Colors */
            --chart-1: #03dac6;
            --chart-2: #ff4081;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            padding: 2rem;
            min-height: 100vh;
            padding-bottom: 4rem;
        }
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 1.5rem;
            gap: 1.5rem; flex-wrap: wrap;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-logo-img { width: 48px; height: 48px; object-fit: contain; }

        #appTitle {
            font-weight: 300; letter-spacing: 1px; color: var(--accent); margin: 0;
            border-bottom: 1px dashed transparent; cursor: text; transition: border 0.2s;
        }
        #appTitle:hover { border-bottom-color: var(--accent); }
        #appTitle:focus { outline: none; border-bottom: 1px solid var(--accent); }
        .date-display { color: var(--text-muted); font-size: 0.9rem; font-family: monospace; margin-top: 5px; }
        .header-actions { display: flex; gap: 0.8rem; align-items: center; flex-wrap: wrap; }

        .btn {
            background: var(--input-bg); border: 1px solid var(--accent); color: var(--accent);
            padding: 0.6rem 1.2rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem;
            transition: all 0.2s; font-weight: 600;
        }
        .btn:hover { background: var(--accent); color: #000; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.75rem; }

        .btn-reset {
            background: transparent; border: 1px solid #444; color: var(--text-muted);
            padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 0.7rem;
            margin-top: 0.8rem; width: auto; display: inline-block; transition: all 0.2s;
        }
        .btn-reset:hover { border-color: var(--g-red); color: var(--g-red); }

        .team-overview-panel {
            background-color: var(--card-bg); border: 1px solid var(--border); border-radius: 8px;
            padding: 1.5rem; margin-bottom: 2rem; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem;
        }
        .overview-col h4 {
            color: var(--accent); font-size: 0.85rem; text-transform: uppercase;
            border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; margin-bottom: 0.5rem;
        }
        .date-suffix { color: var(--text-muted); font-weight: normal; font-size: 0.8em; margin-left: 8px; text-transform: none; }
        .edit-hint { font-size: 0.7rem; color: #666; font-style: italic; margin-bottom: 1rem; display: block; }
        .overview-list { list-style: none; font-size: 0.9rem; line-height: 1.4; color: var(--text-main); }
        .overview-list li { margin-bottom: 0.5rem; position: relative; padding-left: 1rem; }
        .overview-list li::before { content: "•"; position: absolute; left: 0; color: #fff; }
        .auto-item { color: var(--text-main); }
        .auto-item b { color: var(--text-muted); margin-right: 5px; }
        .overview-col.interactive {
            cursor: pointer; position: relative; transition: background 0.2s; border-radius: 4px; padding: 0.5rem; margin: -0.5rem;
        }
        .overview-col.interactive:hover { background: rgba(255,255,255,0.05); }
        .overview-col.interactive::after {
            content: "✎"; position: absolute; top: 0.5rem; right: 0.5rem; color: var(--text-muted); opacity: 0; transition: opacity 0.2s;
        }
        .overview-col.interactive:hover::after { opacity: 1; }
        #additionalInfoPreview { font-size: 0.9rem; line-height: 1.5; color: var(--text-main); pointer-events: none; }
        #additionalInfoPreview ul { padding-left: 1.2rem; margin-bottom: 0.5rem; }
        #additionalInfoPreview li { margin-bottom: 0.2rem; }
        #additionalInfoPreview b { color: #fff; }
        #additionalInfoPreview a { color: var(--chart-1); text-decoration: none; border-bottom: 1px dashed var(--chart-1); cursor: pointer; pointer-events: auto; }
        #additionalInfoPreview a:hover { border-bottom-style: solid; }
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; border-top: 1px solid var(--border); padding-top: 1rem;
        }
        .section-header.first { border-top: none; padding-top: 0; }
        .tracker-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;
        }
        .tracker-card {
            background-color: var(--card-bg); border: 1px solid var(--border); border-radius: 8px;
            padding: 1.5rem; text-align: center; position: relative; cursor: pointer; transition: transform 0.2s;
            min-height: 280px; display: flex; flex-direction: column; justify-content: space-between;
        }
        .tracker-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .tracker-desc { font-weight: bold; margin-bottom: 1rem; color: var(--text-main); height: 30px; display: flex; align-items: center; justify-content: center;}
        .tracker-viz-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; height: 160px; overflow: hidden; }
        .pie-chart {
            width: 120px; height: 120px; border-radius: 50%; margin: 0 auto;
            background: conic-gradient(var(--g-green) 0% 0%, var(--g-red) 0% 100%);
            position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .pie-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--card-bg); width: 96px; height: 96px; border-radius: 50%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .pie-pct { font-size: 1.4rem; font-weight: bold; color: var(--text-main); }
        .tracker-stats { font-size: 0.8rem; color: var(--text-muted); margin-top: auto; padding-top:1rem; }
        .btn-del-tracker {
            position: absolute; top: 10px; right: 10px; color: #666; background: none; border: none; cursor: pointer; font-size: 1.2rem; z-index: 2;
        }
        .btn-del-tracker:hover { color: var(--g-red); }
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1.5rem; }
        .member-card {
            background-color: var(--card-bg); border: 1px solid var(--border); border-radius: 8px;
            transition: transform 0.2s; position: relative; cursor: pointer; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .member-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .card-half { padding: 1.2rem; display: flex; flex-direction: column; gap: 1rem; }
        .card-top { background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); }
        .card-bottom { background: transparent; }
        .half-header { display: flex; justify-content: space-between; align-items: center; }
        .half-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: bold; letter-spacing: 1px; }
        .member-name-row { padding: 1rem 1.2rem 0; font-size: 1.4rem; font-weight: bold; color: var(--text-main); }
        .card-task-list { list-style: none; font-size: 0.9rem; color: #ddd; }
        .card-task-li { margin-bottom: 0.4rem; display: flex; gap: 8px; align-items: flex-start; }
        .card-task-li input[type="checkbox"] { margin-top: 4px; accent-color: var(--accent); cursor: pointer; }
        .gauge-container { width: 60px; height: 35px; position: relative; text-align: center; }
        .gauge-val { position: absolute; bottom: -5px; width: 100%; text-align: center; font-size: 0.75rem; font-weight: bold; }
        .daily-mini-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; margin-top: auto; }
        .dm-box { text-align: center; background: var(--input-bg); padding: 4px 2px; border-radius: 2px; }
        .dm-day { font-size: 0.55rem; color: var(--text-muted); display: block; }
        .dm-val { font-size: 0.75rem; font-weight: bold; }
        .val-H { color: var(--g-red); } .val-M { color: var(--g-amber); }
        .val-L { color: var(--g-green); } .val-X { color: var(--g-grey); opacity: 0.7; font-weight: normal; }
        #globalTooltip {
            position: fixed; background: #222; color: #fff; padding: 10px; border: 1px solid #555;
            border-radius: 4px; font-size: 0.8rem; white-space: pre-wrap; width: 220px;
            z-index: 99999; box-shadow: 0 4px 15px rgba(0,0,0,0.8); pointer-events: none; display: none; line-height: 1.4;
        }
        .help-icon {
            display: inline-block; width: 16px; height: 16px; background: #444; color: #aaa;
            border-radius: 50%; text-align: center; line-height: 16px; font-size: 11px; font-weight: bold;
            cursor: help; margin-left: 6px; vertical-align: middle;
        }
        .help-icon:hover { background: var(--accent); color: #000; }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--modal-bg); width: 95%; max-width: 900px; max-height: 90vh;
            border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .modal-mini { max-width: 400px; text-align: center; }
        .modal-large { width: 90%; height: 85%; max-width: 1200px; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 2rem; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 1rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .form-section-title { color: var(--accent); font-size: 0.9rem; text-transform: uppercase; margin-bottom: 1rem; border-bottom: 1px solid #444; padding-bottom: 0.5rem; }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.4rem; }
        input[type="text"], input[type="number"], textarea {
            width: 100%; padding: 0.6rem; background: var(--input-bg); border: 1px solid var(--border);
            color: #fff; border-radius: 4px; font-size: 0.9rem;
        }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; }
        .load-select-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .ls-box { text-align: center; } .ls-box label { font-size: 0.7rem; margin-bottom: 2px; }
        select { width: 100%; padding: 4px; background: var(--input-bg); color: #fff; border: 1px solid var(--border); text-align: center; border-radius: 4px; cursor: pointer; }
        option { background: var(--input-bg); color: #fff; }
        .type-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        .type-option {
            padding: 0.8rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--text-muted);
            background: transparent; font-weight: bold; font-size: 0.8rem; text-align: center;
        }
        .type-option:hover { background: rgba(255,255,255,0.05); }
        .type-option.active { background: var(--accent); color: #000; border-color: var(--accent); }
        #barSeriesContainer, #lineSeriesContainer {
            max-height: 300px; overflow-y: auto; padding-right: 5px; border: 1px solid var(--border); border-radius: 4px; padding: 10px; background: rgba(0,0,0,0.2);
        }
        .grid-24 { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }
        input[type="color"] {
            -webkit-appearance: none; border: 1px solid #444; width: 40px; height: 40px; cursor: pointer; background: none; padding: 0; vertical-align: middle;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }
        input[type="color"]::-moz-color-swatch { border: none; border-radius: 4px; }
        .counter-display { font-size: 3rem; font-weight: 300; color: var(--accent); line-height: 1; text-shadow: 0 0 20px rgba(187, 134, 252, 0.3); }
        .counter-sub { font-size: 0.9rem; color: var(--text-muted); margin-top: 5px; }
        .ryg-indicator {
            width: 80px; height: 80px; border-radius: 50%; margin: 0 auto; transition: background 0.3s, box-shadow 0.3s;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: #000;
        }
        .ryg-green { background: var(--g-green); box-shadow: 0 0 15px var(--g-green); }
        .ryg-amber { background: var(--g-amber); box-shadow: 0 0 15px var(--g-amber); }
        .ryg-red { background: var(--g-red); box-shadow: 0 0 15px var(--g-red); }
        .ryg-grey { background: var(--g-grey); box-shadow: none; color: #fff; }
        .rag-selector { display: flex; gap: 10px; margin-top: 5px; }
        .rag-pill {
            flex: 1; padding: 10px; border: 2px solid transparent; border-radius: 20px; text-align: center; font-weight: bold; cursor: pointer; opacity: 0.5; transition: all 0.2s;
        }
        .rag-pill.selected { opacity: 1; transform: scale(1.05); }
        .rag-pill[data-val="green"] { background: var(--g-green); color: #000; }
        .rag-pill[data-val="amber"] { background: var(--g-amber); color: #000; }
        .rag-pill[data-val="red"] { background: var(--g-red); color: #000; }
        .rag-pill[data-val="grey"] { background: var(--g-grey); color: #fff; }
        #wafflePreview { display: grid; grid-template-columns: repeat(10, 1fr); gap: 1px; width: 60px; margin: 10px auto; }
        .waffle-cell { aspect-ratio: 1; background: #333; border-radius: 1px; }
        body.publishing .header-actions, body.publishing .btn-del-tracker, body.publishing .section-header button, body.publishing .overview-col.interactive::after, body.publishing .edit-hint, body.publishing .help-icon, body.publishing .btn-reset { display: none !important; }
        body.publishing #publishToggleBtn { display: block !important; position: fixed; top: 20px; right: 20px; z-index: 9999; }
        body.publishing .auto-item b { display: none; }
        body.publishing .tracker-card { cursor: zoom-in; }
        body.publishing .member-card { cursor: default; }
        body.publishing #appTitle { pointer-events: none; border-bottom: none; }
        body.publishing .overview-col.interactive { pointer-events: auto; }
        body.publishing .overview-col { cursor: zoom-in; }
        body.publishing .overview-col:hover { background: rgba(255,255,255,0.05); }
        body.publishing #additionalInfoPreview { pointer-events: auto; }
        #publishToggleBtn { display: none; }
        .zoomed-content ul { font-size: 1.5rem; line-height: 2; padding-left: 2rem; }
        .zoomed-content li { margin-bottom: 1rem; }
        .zoomed-content p { font-size: 1.2rem; line-height: 1.6; }
        .zoomed-content b { color: #fff; }
        .zoomed-content a { color: var(--chart-1); text-decoration: none; border-bottom: 1px dashed var(--chart-1); }
        @media print {
            body { background: #121212 !important; color: #e0e0e0 !important; -webkit-print-color-adjust: exact; }
            .header-actions, .modal-overlay, .btn, .btn-del-tracker, #publishToggleBtn, .btn-reset { display: none !important; }
            .member-card, .team-overview-panel, .tracker-card { break-inside: avoid; border: 1px solid #444 !important; }
            .card-top { background: #1a1a1a !important; }
            .section-header button { display: none; }
            body.publishing .auto-item b { display: none; }
        }
    </style>
</head>
<body>
    <button id="publishToggleBtn" class="btn btn-primary" onclick="App.togglePublishMode()">Edit View</button>
    <header>
        <div class="header-left">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYmI4NmZjIiBzdHJva2Utd2lkdGg9IjIiB5PSIyIj48L3JlY3Q+PHJlY3QgeD0iMiIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSI4IiByeD0iMiIgcnk9IjIiPjwvcmVjdD48bGluZTB4MT0iNiIgeTE9IjYiIHgyPSI2LjAxIiB5MT0iMTgiPjwvcmVjdD48bGluZTB4MT0iNiIgeTE9IjYiIHgyPSI2LjAxIiB5MT0iMTgiPjwvbGluZT48L3N2Z+" alt="Logo" class="header-logo-img">
            <div>
                <h1 id="appTitle" contenteditable="true" spellcheck="false" onblur="App.saveTitle()">Server Platforms</h1>
                <div class="date-display" id="dateRangeDisplay">...</div>
            </div>
        </div>
        <div class="header-actions">
            <input type="file" id="fileInput" style="display: none;" accept=".json,.csv" onchange="DataLoader.loadFromFile(this)">
            <button class="btn" onclick="document.getElementById('fileInput').click()">Load Data</button>
            <button class="btn" onclick="DataSaver.saveData()">Save JSON</button>
            <button class="btn" onclick="DataExporter.exportCSV()">Export CSV</button>
            <button class="btn" onclick="App.togglePublishMode()">Publish View</button>
            <button class="btn btn-primary" onclick="UserManager.openUserModal()">+ Add User</button>
        </div>
    </header>
    <div class="container">
        <div class="team-overview-panel">
            <div class="overview-col" onclick="OverviewManager.handleOverviewClick('success')">
                <h4 id="overviewTitleCurrent">Top 5 Team Achievements</h4>
                <div class="edit-hint">(Check max 5 boxes in Last Week)</div>
                <ul class="overview-list" id="teamSuccessList"><li>No items selected.</li></ul>
                <button class="btn-reset" onclick="event.stopPropagation(); OverviewManager.resetSelections('success')">Reset Selection</button>
            </div>
            <div class="overview-col" onclick="OverviewManager.handleOverviewClick('activity')">
                <h4 id="overviewTitleNext">Top 5 Activities Next Week</h4>
                <div class="edit-hint">(Check max 5 boxes in Next Week)</div>
                <ul class="overview-list" id="teamActivityList"><li>No items selected.</li></ul>
                <button class="btn-reset" onclick="event.stopPropagation(); OverviewManager.resetSelections('activity')">Reset Selection</button>
            </div>
            <div class="overview-col interactive" onclick="OverviewManager.handleInfoClick()">
                <h4>Additional Info</h4>
                <div class="edit-hint">(Click anywhere to edit)</div>
                <div id="additionalInfoPreview"></div>
            </div>
        </div>
        <div class="section-header first">
            <h3 style="color:var(--accent); font-weight:300;">Progress Trackers</h3>
            <button class="btn" onclick="TrackerManager.openModal()">+ Add Tracker</button>
        </div>
        <div class="tracker-grid" id="trackerGrid"></div>
        <div class="section-header">
            <h3 style="color:var(--accent); font-weight:300;">Team Members</h3>
        </div>
        <div class="team-grid" id="teamGrid"></div>
    </div>
    <div id="globalTooltip"></div>
    <div class="modal-overlay" id="alertModal">
        <div class="modal-content modal-mini">
            <div class="modal-body" style="padding-bottom:1rem;">
                <h3 style="margin-bottom:1rem; color:var(--accent);">Notice</h3>
                <p id="alertMessage" style="font-size:1rem; color:#fff;"></p>
            </div>
            <div class="modal-footer" style="justify-content:center; border-top:none;">
                <button class="btn btn-primary" onclick="ModalManager.closeModal('alertModal')">OK</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content modal-mini">
            <div class="modal-body" style="padding-bottom:1rem;">
                <h3 style="margin-bottom:1rem; color:var(--accent);">Confirm</h3>
                <p id="confirmMessage" style="font-size:1rem; color:#fff;"></p>
            </div>
            <div class="modal-footer" style="justify-content:center; border-top:none; gap:1rem;">
                <button class="btn" onclick="ModalManager.closeModal('confirmModal')">Cancel</button>
                <button id="confirmYesBtn" class="btn btn-primary">Yes, Proceed</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="zoomModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="zoomTitle" style="font-size:1.5rem;">View</h3>
                <button class="btn" onclick="ModalManager.closeModal('zoomModal')">&times;</button>
            </div>
            <div class="modal-body" id="zoomBody"></div>
        </div>
    </div>
    <div class="modal-overlay" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add User</h3>
                <button class="btn" onclick="ModalManager.closeModal('userModal')" style="padding: 0.2rem 0.6rem;">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editIndex" value="-1">
                <div class="input-group">
                    <label>Team Member Name <span class="help-icon" data-text="Enter full name of team member.">?</span></label>
                    <input type="text" id="mName" placeholder="e.g. Alex Chen">
                </div>
                <div class="form-row">
                    <div class="half-form">
                        <div class="form-section-title">Last Week (Mon - Fri)</div>
                        <div class="input-group">
                            <label>Top 3 Successes <span class="help-icon" data-text="Key achievements from the previous week. Check the box on the dashboard to add these to the 'Top 5 Team Achievements'.">?</span></label>
                            <input type="text" class="mb-2" id="lwTask1" placeholder="1. Project A...">
                            <input type="text" class="mb-2" id="lwTask2" style="margin-top:5px" placeholder="2. Client Call...">
                            <input type="text" class="mb-2" id="lwTask3" style="margin-top:5px" placeholder="3. Bug fix...">
                        </div>
                        <div class="input-group">
                            <label>Workload <span class="help-icon" data-text="Daily workload intensity. L=Low, M=Medium, H=High, X=Absence.">?</span></label>
                            <div class="load-select-row">
                                <div class="ls-box"><label>M</label><select id="lw0"><option title="Low">L</option><option title="Medium">M</option><option title="High">H</option><option title="Absence">X</option></select></div>
                                <div class="ls-box"><label>T</label><select id="lw1"><option title="Low">L</option><option title="Medium">M</option><option title="High">H</option><option title="Absence">X</option></select></div>
                                <div class="ls-box"><label>W</label><select id="lw2"><option title="Low">L</option><option title="Medium">M</option><option title="High">H</option><option title="Absence">X</option></select></div>
                                <div class="ls-box"><label>T</label><select id="lw3"><option title="Low">L</option><option title="Medium">M</option><option title="High">H</option><option title="Absence">X</option></select></div>
                                <div class="ls-box"><label>F</label><select id="lw4"><option title="Low">L</option><option title="Medium">M</option><option title="High">H</option><option title="Absence">X</option></select></div>
                            </div>
                        </div>
                    </div>
                    <div class="half-form">
                        <div class="form-section-title">Next Week (Mon - Fri)</div>
                        <div class="input-group">
                            <label>Top 3 Priorities <span class="help-icon" data-text="Key planned activities. Check the box on the dashboard to add these to the 'Top 5 Activities'.">?</span></label>
                            <input type="text" class="mb-2" id="nwTask1" placeholder="1. Start Phase 2...">
                            <input type="text" class="mb-2" id="nwTask2" style="margin-top:5px" placeholder="2. Planning...">
                            <input type="text" class="mb-2" id="nwTask3" style="margin-top:5px" placeholder="3. Code Review...">
                        </div>
                        <div class="input-group">
                            <label>Workload <span class="help-icon" data-text="Daily workload intensity. L=Low, M=Medium, H=High, X=Absence.">?</span></label>
                            <div class="load-select-row">
                                <div class="ls-box"><label>M</label><select id="nw0"><option title="Low">L</option><option title="Medium">M</option><option title="High">H</option><option title="Absence">X</option></select></div>
                                <div class="ls-box"><label>T</label><select id="nw1"><option title="Low">L</option><option title="Medium">M</option><option title="High">H</option><option title="Absence">X</option></select></div>
                                <div class="ls-box"><label>W</label><select id="nw2"><option title="Low">L</option><option title="Medium">M</option><option title="High">H</option><option title="Absence">X</option></select></div>
                                <div class="ls-box"><label>T</label><select id="nw3"><option title="Low">L</option><option title="Medium">M</option><option title="High">H</option><option title="Absence">X</option></select></div>
                                <div class="ls-box"><label>F</label><select id="nw4"><option title="Low">L</option><option title="Medium">M</option><option title="High">H</option><option title="Absence">X</option></select></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="color: var(--g-red); border-color:var(--g-red);" onclick="UserManager.deleteUser()" id="deleteBtn">Delete</button>
                <button class="btn btn-primary" onclick="UserManager.submitUser()">Save User</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="infoModal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h3>Additional Information</h3>
                <button class="btn" onclick="ModalManager.closeModal('infoModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size:0.8rem; color:#888; margin-bottom:1rem;">Supports: bold, italic, - list item, [link](url)</p>
                <textarea id="additionalInfoInput" style="height:200px; resize:none;" placeholder="Enter risks, blockers, or general notes..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="UserManager.saveAdditionalInfo()">Update Info</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="trackerModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="trackerModalTitle">Add Progress Tracker</h3>
                <button class="btn" onclick="ModalManager.closeModal('trackerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTrackerIndex" value="-1">
                <div class="type-selector" id="trackerTypeSelector">
                    <button class="type-option active" data-type="gauge" onclick="TrackerManager.setType('gauge')">Gauge (Pie)</button>
                    <button class="type-option" data-type="bar" onclick="TrackerManager.setType('bar')">Bar Graph</button>
                    <button class="type-option" data-type="line" onclick="TrackerManager.setType('line')">Line Graph</button>
                    <button class="type-option" data-type="counter" onclick="TrackerManager.setType('counter')">Counter</button>
                    <button class="type-option" data-type="rag" onclick="TrackerManager.setType('rag')">RAG Status</button>
                    <button class="type-option" data-type="waffle" onclick="TrackerManager.setType('waffle')">Waffle Chart</button>
                </div>
                <div class="input-group">
                    <label>Tracker Title</label>
                    <input type="text" id="tkDesc">
                </div>
                <div id="gaugeInputs">
                    <div class="input-group"><label>Metric Name</label><input type="text" id="tkMetric"></div>
                    <div class="form-row" style="margin-bottom:0; gap:1rem;">
                        <div class="input-group"><label>Completed</label><input type="number" id="tkComp"></div>
                        <div class="input-group"><label>Total</label><input type="number" id="tkTotal"></div>
                    </div>
                    <div class="input-group">
                        <label>Color</label>
                        <input type="color" id="tkPieColor" value="#03dac6">
                    </div>
                </div>
                <div id="barInputs" style="display:none;">
                    <div class="input-group">
                        <label>Y-Axis Label</label>
                        <input type="text" id="tkBarYLabel">
                    </div>
                    <div class="input-group">
                        <label>X-Axis Labels (Up to 24)</label>
                        <div id="barLabelsContainer" class="grid-24"></div>
                    </div>
                    <div class="input-group" style="border-top:1px solid #333; padding-top:1rem;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <label style="margin:0;">Data Series (Up to 10)</label>
                            <button class="btn btn-sm" onclick="TrackerManager.addBarSeries()">+ Add Series</button>
                        </div>
                        <div id="barSeriesContainer"></div>
                    </div>
                </div>
                <div id="lineInputs" style="display:none;">
                    <div class="input-group">
                        <label>X-Axis Labels (Up to 24)</label>
                        <div id="lineLabelsContainer" class="grid-24"></div>
                    </div>
                    <div class="input-group" style="border-top:1px solid #333; padding-top:1rem;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <label style="margin:0;">Data Series (Up to 10)</label>
                            <button class="btn btn-sm" onclick="TrackerManager.addLineSeries()">+ Add Series</button>
                        </div>
                        <div id="lineSeriesContainer"></div>
                    </div>
                </div>
                <div id="counterInputs" style="display:none;">
                    <div class="input-group">
                        <label>Counter Value</label>
                        <input type="number" id="tkCounterVal">
                    </div>
                    <div class="input-group">
                        <label>Subtitle / Description</label>
                        <input type="text" id="tkCounterSub" placeholder="e.g. Active Incidents">
                    </div>
                </div>
                <div id="ragInputs" style="display:none;">
                    <div class="input-group">
                        <label>Status</label>
                        <div class="rag-selector">
                            <div class="rag-pill" data-val="green" onclick="TrackerManager.selectRag('green')">Green</div>
                            <div class="rag-pill" data-val="amber" onclick="TrackerManager.selectRag('amber')">Amber</div>
                            <div class="rag-pill" data-val="red" onclick="TrackerManager.selectRag('red')">Red</div>
                            <div class="rag-pill" data-val="grey" onclick="TrackerManager.selectRag('grey')">Unknown</div>
                        </div>
                        <input type="hidden" id="tkRagStatus">
                    </div>
                    <div class="input-group">
                        <label>Status Message</label>
                        <input type="text" id="tkRagMsg" placeholder="e.g. All Systems Operational">
                    </div>
                </div>
                <div id="waffleInputs" style="display:none;">
                    <div class="input-group">
                        <label>Total Count</label>
                        <input type="number" id="tkWaffleTotal" oninput="TrackerManager.updateWafflePreview()">
                    </div>
                    <div class="input-group">
                        <label>Completed / Active Count</label>
                        <input type="number" id="tkWaffleActive" oninput="TrackerManager.updateWafflePreview()">
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Value Color</label>
                            <input type="color" id="tkWaffleColorVal" value="#03dac6" oninput="TrackerManager.updateWafflePreview()">
                        </div>
                        <div class="input-group">
                            <label>Background Color</label>
                            <input type="color" id="tkWaffleColorBg" value="#333333" oninput="TrackerManager.updateWafflePreview()">
                        </div>
                    </div>
                    <div style="margin-top:20px; padding:10px; border:1px dashed #444; border-radius:4px; text-align:center;">
                        <label style="font-size:0.7rem; text-transform:uppercase; color:#aaa;">Preview</label>
                        <div id="wafflePreview">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="TrackerManager.submitTracker()">Save Tracker</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * SERVER PLATFORMS TRACKER v29
         * SINGLE SCRIPT SOLUTION - No modules, just one big function flow.
         */
        (function() {
            // --- GLOBAL STATE ---
            const State = {
                title: "Server Platforms",
                additionalInfo: "",
                trackers: [],
                members: [],
                editingTrackerIndex: -1,
                currentTrackerType: 'gauge'
            };

            // --- DOM HELPERS ---
            const getEl = (id) => document.getElementById(id);

            // --- INIT ---
            const initApp = () => {
                const formatDate = (date) => date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                const getRanges = () => {
                    const today = new Date();
                    const d = today.getDay();
                    const diff = d === 0 ? -6 : 1 - d;
                    const cm = new Date(today);
                    cm.setDate(today.getDate() + diff);
                    const cf = new Date(cm);
                    cf.setDate(cm.getDate() + 4);
                    const nm = new Date(cm);
                    nm.setDate(cm.getDate() + 7);
                    const nf = new Date(nm);
                    nf.setDate(nm.getDate() + 4);
                    return { current: `${formatDate(cm)} - ${formatDate(cf)}`, next: `${formatDate(nm)} - ${formatDate(nf)}` };
                };
                
                const updateDateUI = () => {
                    const r = getRanges();
                    getEl('dateRangeDisplay').innerText = `Current: ${r.current} | Next: ${r.next}`;
                    getEl('overviewTitleCurrent').innerHTML = `Top 5 Team Achievements <span class="date-suffix">${r.current}</span>`;
                    getEl('overviewTitleNext').innerHTML = `Top 5 Activities Next Week <span class="date-suffix">${r.next}</span>`;
                };

                console.log("App Initialized");
            };

            // --- RENDER ---
            const parseMarkdown = (t) => {
                if(!t) return '';
                let h = t.replace(/&/g,"&amp;").replace(/</g,"&lt;")
                         .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
                         .replace(/\*(.*?)\*/g,'<i>$1</i>')
                         .replace(/\[(.*?)\]\((.*?)\)/g, (match, text, url) => {
                             let finalUrl = url;
                             if(!/^https?:\/\//i.test(url)) finalUrl = 'https://' + url;
                             return `<a href="${finalUrl}" target="_blank">${text}</a>`;
                         });
                return h.split('\n').map(l=>l.trim().startsWith('- ')?`<li>${l.substring(2)}</li>`:l+'<br>').join('').replace(/<\/li><br><li>/g,'</li><li>').replace(/<br><li>/g,'<ul><li>').replace(/<\/li><br>/g,'</li></ul>');
            };

            const createGaugeSVG = (loadArr) => {
                let t=0; let c=0; 
                loadArr.forEach(v => { 
                    if(v==='H'){t+=100;c++}else if(v==='M'){t+=70;c++}else if(v==='L'){t+=30;c++} 
                });
                const s = c===0?0:Math.round(t/c); 
                const r=15, cx=30, cy=30; 
                const rad=(Math.min(s,100)/100)*180*Math.PI/180;
                const bg=`M ${cx-r} ${cy} A ${r} ${r} 0 0 1 ${cx+r} ${cy}`;
                const val=s>0?`M ${cx-r} ${cy} A ${r} ${r} 0 0 1 ${cx+r*Math.cos(rad-Math.PI)} ${cy+r*Math.sin(rad-Math.PI)}`:'';
                const color = s >= 90 ? '#ff1744' : s >= 51 ? '#ffb300' : '#00e676';
                return `<svg width="60" height="35" viewBox="0 0 60 35"><path d="${bg}" fill="none" stroke="#333" stroke-width="4" stroke-linecap="round"/><path d="${val}" fill="none" stroke="${color}" stroke-width="4" stroke-linecap="round"/><circle cx="${cx}" cy="${cy}" r="2" fill="#fff"/></svg><div class="gauge-val" style="color:${color}">${s}%</div>`;
            };

            const createWaffleHTML = (total, active, colorVal, colorBg) => {
                const maxCells = 100;
                let html = '<div style="display:grid; grid-template-columns: repeat(10, 1fr); gap: 2px; width: 140px; margin: 0 auto;">';
                for(let i=0; i<maxCells; i++) {
                    const isActive = i < active;
                    html += `<div class="waffle-cell" style="${isActive ? `background-color:${colorVal}; box-shadow: 0 0 5px ${colorVal}` : `background-color:${colorBg}`}"></div>`;
                }
                html += '</div>';
                return html;
            };

            const renderBoard = () => {
                console.log("Rendering Board...");

                // Render Header
                getEl('appTitle').innerText = State.title || "Server Platforms";
                
                // Render Overview
                const sL = getEl('teamSuccessList'); 
                const aL = getEl('teamActivityList');
                sL.innerHTML = ''; 
                aL.innerHTML = ''; 
                let sc = 0, ac = 0;

                State.members.forEach(m => {
                    m.lastWeek.tasks.forEach(t => {
                        if(t.isTeamSuccess && t.text.trim()) { 
                            sc++; 
                            sL.innerHTML += `<li class="auto-item"><b>${m.name}:</b> ${t.text}</li>`; 
                        }
                    });
                    m.nextWeek.tasks.forEach(t => {
                        if(t.isTeamActivity && t.text.trim()) { 
                            ac++; 
                            aL.innerHTML += `<li class="auto-item"><b>${m.name}:</b> ${t.text}</li>`; 
                        }
                    });
                });

                if(sc===0) sL.innerHTML='<li>No items selected.</li>'; 
                if(ac===0) aL.innerHTML='<li>No items selected.</li>';
                
                getEl('additionalInfoPreview').innerHTML = parseMarkdown(State.additionalInfo) || "No additional info.";

                // Render Trackers
                const tGrid = getEl('trackerGrid');
                tGrid.innerHTML = '';
                
                State.trackers.forEach((t, i) => {
                    const card = document.createElement('div');
                    card.className = 'tracker-card';
                    card.onclick = () => ZoomManager.openChartModal(i);

                    let visualHTML = '';
                    let statsHTML = '';
                    
                    // Normalized type for rendering
                    let renderType = t.type;
                    if (renderType === 'line1' || renderType === 'line2') renderType = 'line';
                    if (renderType === 'ryg') renderType = 'rag';

                    if (renderType === 'counter') {
                        visualHTML = `<div class="counter-display" style="color:${t.color1}">${t.value}</div>`;
                        statsHTML = `<div class="counter-sub">${t.subtitle || ''}</div>`;
                    } else if (renderType === 'rag' || renderType === 'ryg') {
                        const status = (renderType === 'ryg') ? t.status : (t.color1 === '#ff1744' ? 'red' : (t.color1 === '#ffb300' ? 'amber' : 'green'));
                        const icon = status === 'red' ? '!' : (status === 'amber' ? '⚠' : (status === 'green' ? '✓' : '?'));
                        const color = t.color1 || (status === 'green' ? '#00e676' : (status === 'amber' ? '#ffb300' : '#ff1744'));
                        visualHTML = `<div class="ryg-indicator" style="background:${color}; box-shadow: 0 0 15px ${color}">${icon}</div>`;
                        statsHTML = `<div class="counter-sub" style="margin-top:10px; font-weight:bold;">${t.message || ''}</div>`;
                    } else if (renderType === 'waffle') {
                        const html = createWaffleHTML(100, t.active || 0, t.colorVal || '#03dac6', t.colorBg || '#333333');
                        visualHTML = html;
                        statsHTML = `<div class="tracker-stats">${t.active} / ${t.total}</div>`;
                    } else if (renderType === 'line' || renderType === 'line1' || renderType === 'line2') {
                        let labels = []; let series = [];
                        if (renderType === 'line1' || renderType === 'line2') {
                            labels = t.data.map(d => d.label);
                            series.push({ name: t.y1Leg || 'Series 1', color: t.color1 || '#03dac6', values: t.data.map(d => d.y1 || 0) });
                            if (renderType === 'line2') series.push({ name: t.y2Leg || 'Series 2', color: t.color2 || '#ff4081', values: t.data.map(d => d.y2 || 0) });
                        } else {
                            labels = t.labels || []; series = t.series || [];
                        }
                        visualHTML = `<div style="width:100%; height:120px; margin-bottom:10px;">${Visuals.createLineChartSVG(labels, series)}</div>`;
                    } else if (renderType === 'bar') {
                        if (t.series) {
                            visualHTML = `<div style="width:100%; height:120px; margin-bottom:10px;">${Visuals.createMultiBarChartSVG(t.labels, t.series)}</div>`;
                        } else {
                            visualHTML = `<div style="width:100%; height:120px; margin-bottom:10px;">${Visuals.createBarChartSVG(t.data, t.yLabel, t.color1)}</div>`;
                        }
                    } else {
                        const pct = t.total > 0 ? Math.round((t.completed/t.total)*100) : 0;
                        const c1 = t.colorVal || t.color1 || '#00e676'; 
                        const c2 = t.color2 || '#ff1744';
                        const grad = `conic-gradient(${c1} 0% ${pct}%, ${c2} ${pct}% 100%)`;
                        visualHTML = `<div class="pie-chart" style="background:${grad}"><div class="pie-overlay"><div class="pie-pct">${pct}%</div></div></div>`;
                        statsHTML = `<div class="tracker-stats">${t.completed} / ${t.total} ${t.metric}</div>`;
                    }

                    card.innerHTML = `<button class="btn-del-tracker" onclick="event.stopPropagation(); TrackerManager.deleteTracker(${i})">&times;</button>`;
                    card.innerHTML += `<div class="tracker-desc">${t.desc}</div>`;
                    card.innerHTML += `<div class="tracker-viz-container">${visualHTML}</div>`;
                    card.innerHTML += `<div class="tracker-stats">${statsHTML}</div>`;

                    tGrid.appendChild(card);
                });

                // Render Users
                const grid = getEl('teamGrid');
                grid.innerHTML = '';
                State.members.forEach((m, i) => {
                    let lw = ''; 
                    m.lastWeek.tasks.forEach((t,x) => {
                        if(t.text.trim()) lw += `<li class="card-task-li" onclick="event.stopPropagation()"><input type="checkbox" ${t.isTeamSuccess?'checked':''} onchange="UserManager.toggleSuccess(${i},${x})"><span>${t.text}</span></li>`;
                    });
                    let nw = ''; 
                    m.nextWeek.tasks.forEach((t,x) => {
                        if(t.text.trim()) nw += `<li class="card-task-li" onclick="event.stopPropagation()"><input type="checkbox" ${t.isTeamActivity?'checked':''} onchange="UserManager.toggleActivity(${i},${x})"><span>${t.text}</span></li>`;
                    });
                    
                    const mg = (a) => a.map((v,k) => `<div class="dm-box"><span class="dm-day">${['M','T','W','T','F'][k]}</span><span class="dm-val val-${v}">${v}</span></div>`).join('');
                    
                    const c = document.createElement('div');
                    c.className = 'member-card';
                    c.onclick = () => UserManager.openUserModal(i);
                    
                    c.innerHTML = `<div class="member-name-row">${m.name}</div>`;
                    c.innerHTML += `<div class="card-half card-top">`;
                    c.innerHTML += `<div class="half-header"><span class="half-label">Last Week (Successes)</span>`;
                    c.innerHTML += `<div class="gauge-container">${createGaugeSVG(m.lastWeek.load)}</div>`;
                    c.innerHTML += `</div>`;
                    c.innerHTML += `<ul class="card-task-list">${lw || '<li>No tasks</li>'}</ul>`;
                    c.innerHTML += `<div class="daily-mini-grid">${mg(m.lastWeek.load)}</div>`;
                    c.innerHTML += `</div>`;
                    
                    c.innerHTML += `<div class="card-half card-bottom">`;
                    c.innerHTML += `<div class="half-header"><span class="half-label">Next Week (Priorities)</span>`;
                    c.innerHTML += `<div class="gauge-container">${createGaugeSVG(m.nextWeek.load)}</div>`;
                    c.innerHTML += `</div>`;
                    c.innerHTML += `<ul class="card-task-list">${nw || '<li>No tasks</li>'}</ul>`;
                    c.innerHTML += `<div class="daily-mini-grid">${mg(m.nextWeek.load)}</div>`;
                    c.innerHTML += `</div>`;

                    grid.appendChild(c);
                });
            };

            // --- ZOOM MANAGER ---
            const ZoomManager = {
                openChartModal: (index) => {
                    const t = State.trackers[index];
                    if(!t) return;

                    getEl('zoomTitle').innerText = t.desc;
                    let content = '';
                    
                    let renderType = t.type;
                    if (renderType === 'line1' || renderType === 'line2') renderType = 'line';
                    if (renderType === 'ryg') renderType = 'rag';

                    if (renderType === 'counter') {
                        content = `<div style="font-size: 6rem; font-weight:300; color:${t.color1}; text-shadow:0 0 20px ${t.color1}">${t.value}</div><div style="font-size:1.5rem; color:#aaa; margin-top:1rem;">${t.subtitle}</div>`;
                    } else if (renderType === 'rag' || renderType === 'ryg') {
                        const status = (renderType === 'ryg') ? t.status : t.color1 === '#ff1744' ? 'red' : (t.color1 === '#ffb300' ? 'amber' : 'green');
                        const icon = status === 'red' ? 'CRITICAL' : (status === 'amber' ? 'WARNING' : (status === 'green' ? 'GOOD' : 'UNKNOWN'));
                        const color = t.color1 || (status === 'green' ? '#00e676' : (status === 'amber' ? '#ffb300' : '#ff1744'));
                        content = `<div class="ryg-indicator" style="background:${color}; width:200px; height:200px; font-size:2rem;">${icon}</div><div style="margin-top:2rem; font-size:1.5rem;">${t.message || ''}</div>`;
                    } else if (renderType === 'waffle') {
                        content = createWaffleHTML(100, t.active || 0, t.colorVal || '#03dac6', t.colorBg || '#333333');
                    } else if (renderType === 'line' || renderType === 'line1' || renderType === 'line2') {
                        let labels = []; let series = [];
                        if (renderType === 'line1' || renderType === 'line2') {
                            labels = t.data.map(d => d.label);
                            series.push({ name: t.y1Leg || 'Series 1', color: t.color1 || '#03dac6', values: t.data.map(d => d.y1 || 0) });
                            if (renderType === 'line2') series.push({ name: t.y2Leg || 'Series 2', color: t.color2 || '#ff4081', values: t.data.map(d => d.y2 || 0) });
                        } else {
                            labels = t.labels; series = t.series;
                        }
                        content = Visuals.createLineChartSVG(labels, series);
                    } else if (renderType === 'bar') {
                        if (t.series) content = Visuals.createMultiBarChartSVG(t.labels, t.series);
                        else content = Visuals.createBarChartSVG(t.data, t.yLabel, t.color1);
                    } else {
                        const pct = t.total > 0 ? Math.round((t.completed/t.total)*100) : 0;
                        const c1 = t.colorVal || t.color1 || '#00e676'; 
                        const c2 = t.color2 || '#ff1744';
                        const grad = `conic-gradient(${c1} 0% ${pct}%, ${c2} ${pct}% 100%)`;
                        content = `<div class="pie-chart" style="width:300px; height:300px; background:${grad}"><div class="pie-overlay" style="width:260px; height:260px;"><div class="pie-pct" style="font-size:3rem;">${pct}%</div><div style="margin-top:10px; color:#aaa;">${t.completed} / ${t.total}</div></div></div>`;
                    }

                    getEl('zoomBody').className = 'zoom-body-chart';
                    getEl('zoomBody').innerHTML = `<div style="width:100%; height:100%;">${content}</div>`;
                    ModalManager.openModal('zoomModal');
                }
            };

            // --- TRACKER MANAGER ---
            const TrackerManager = {
                openModal: (index) => {
                    console.log("Opening Tracker Modal for index:", index);
                    if (document.body.classList.contains('publishing')) return;

                    State.editingTrackerIndex = index;
                    const isEdit = index > -1;
                    getEl('trackerModalTitle').innerText = isEdit ? 'Edit Progress Tracker' : 'Add Progress Tracker';
                    
                    // Hide all input sections first
                    ['gauge','bar','line','counter','rag','waffle'].forEach(type => {
                        const div = getEl(`${type}Inputs`);
                        if (div) div.style.display = 'none';
                    });

                    // Reset containers
                    getEl('barSeriesContainer').innerHTML = '';
                    getEl('lineSeriesContainer').innerHTML = '';
                    getEl('barLabelsContainer').innerHTML = ''; 
                    getEl('lineLabelsContainer').innerHTML = '';
                    
                    // Fill 24 inputs
                    for(let k=0; k<24; k++) {
                        getEl('barLabelsContainer').innerHTML += `<input type="text" id="bLbl${k}" placeholder="L${k+1}" style="text-align:center;">`;
                        getEl('lineLabelsContainer').innerHTML += `<input type="text" id="lLbl${k}" placeholder="L${k+1}" style="text-align:center;">`;
                    }

                    const tracker = isEdit ? State.trackers[index] : null;
                    
                    // Determine type (normalize legacy)
                    let type = tracker ? tracker.type : 'gauge';
                    if (type === 'line1' || type === 'line2') type = 'line';
                    if (type === 'ryg') type = 'rag'; 
                    
                    this.setType(type);

                    getEl('tkDesc').value = tracker ? tracker.desc : '';

                    // Load Specific Data
                    if (tracker) {
                        if (type === 'line1' || type === 'line2') {
                            const labels = tracker.data.map(d => d.label);
                            labels.forEach((l, k) => { if(k<24) getEl(`lLbl${k}`).value = l; });
                            this.addLineSeries(tracker.y1Leg || 'Series 1', tracker.color1 || '#03dac6', tracker.data.map(d => d.y1));
                            if (type === 'line2') this.addLineSeries(tracker.y2Leg || 'Series 2', tracker.color2 || '#ff4081', tracker.data.map(d => d.y2));
                        } else if (type === 'line') {
                            (tracker.labels||[]).forEach((l, k) => { if(k<24) getEl(`lLbl${k}`).value = l; });
                            (tracker.series||[]).forEach(s => this.addLineSeries(s.name, s.color, s.values));
                        } else if (type === 'bar') {
                            getEl('tkBarYLabel').value = tracker.yLabel || '';
                            const labels = (type === 'bar') ? tracker.labels : tracker.data.map(d => d.label);
                            
                            if (tracker.series) {
                                (tracker.labels||[]).forEach((l, k) => { if(k<24) getEl(`bLbl${k}`).value = l; });
                                (tracker.series||[]).forEach(s => this.addBarSeries(s.name, s.color, s.values));
                            } else {
                                // Legacy Simple Bar
                                (tracker.data||[]).forEach((d,k)=>{if(k<24)getEl(`bLbl${k}`).value=d.label;});
                                if (tracker.data && tracker.data.length > 0) {
                                    const vals = tracker.data.map(d => d.val);
                                    this.addBarSeries('Series 1', tracker.color1 || '#03dac6', vals);
                                }
                            }
                        } else if (type === 'gauge') {
                            getEl('tkMetric').value = tracker.metric || '';
                            getEl('tkComp').value = tracker.completed || '';
                            getEl('tkTotal').value = tracker.total || '';
                            // Handle legacy color1 vs new colorVal
                            getEl('tkPieColor').value = tracker.colorVal || tracker.color1 || '#00e676';
                        } else if (type === 'counter') {
                            getEl('tkCounterVal').value = tracker.value || 0;
                            getEl('tkCounterSub').value = tracker.subtitle || '';
                        } else if (type === 'rag' || type === 'ryg') {
                            this.selectRag(tracker.status || 'grey');
                            getEl('tkRagMsg').value = tracker.message || '';
                        } else if (type === 'waffle') {
                            getEl('tkWaffleTotal').value = tracker.total || 100;
                            getEl('tkWaffleActive').value = tracker.active || 0;
                            getEl('tkWaffleColorVal').value = tracker.colorVal || '#03dac6';
                            getEl('tkWaffleColorBg').value = tracker.colorBg || '#333333';
                            this.updateWafflePreview();
                        }
                    }

                    // Defaults for NEW tracker
                    if (!tracker) {
                        if (type === 'line') {
                            if (getEl('lineSeriesContainer').children.length === 0) this.addLineSeries('Series 1', '#03dac6');
                        }
                        if (type === 'bar') {
                            if (getEl('barSeriesContainer').children.length === 0) this.addBarSeries('Series 1', '#03dac6');
                        }
                        if (type === 'gauge') getEl('tkPieColor').value = '#00e676';
                        if (type === 'rag') this.selectRag('green');
                        if (type === 'waffle') {
                            getEl('tkWaffleColorVal').value = '#03dac6';
                            getEl('tkWaffleColorBg').value = '#333333';
                            this.updateWafflePreview();
                        }
                    }

                    ModalManager.openModal('trackerModal');
                },

                setType: (type) => {
                    State.currentTrackerType = type;
                    
                    // Map all types to data-attr
                    const types = ['Gauge','Bar','Line','Counter','Rag','Waffle'];
                    types.forEach(x => {
                        const btn = getEl(`type${x}Btn`);
                        if (btn) {
                            btn.className = (type === x.toLowerCase()) ? 'type-option active' : 'type-option';
                        }
                        const div = getEl(`${x.toLowerCase()}Inputs`);
                        if (div) div.style.display = (t === type) ? 'block' : 'none'; // Fix reference error
                    });
                },

                selectRag: (val) => {
                    getEl('tkRagStatus').value = val;
                    document.querySelectorAll('.rag-pill').forEach(p => p.classList.remove('selected'));
                    const selected = document.querySelector(`.rag-pill[data-val="${val}"]`);
                    if (selected) selected.classList.add('selected');
                },

                addBarSeries: (name, color, vals) => {
                    const c = getEl('barSeriesContainer');
                    if (c.children.length >= 10) return App.alert("Max 10 series.");
                    c.appendChild(this.createSeriesInputRow('bar', name, color, vals));
                },

                addLineSeries: (name, color, vals) => {
                    const c = getEl('lineSeriesContainer');
                    if (c.children.length >= 10) return App.alert("Max 10 series.");
                    c.appendChild(this.createSeriesInputRow('line', name, color, vals));
                },

                createSeriesInputRow: (type, name, color, vals) => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '1rem';
                    div.style.border = '1px solid #444';
                    div.style.padding = '0.5rem';
                    div.style.borderRadius = '4px';

                    let valInputs = '';
                    for(let k=0; k<24; k++) {
                        valInputs += `<input type="number" class="sv-input" data-idx="${k}" value="${vals[k]||''}" placeholder="${k+1}" style="width:100%; text-align:center;">`;
                    }

                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <input type="text" class="s-name" value="${name}" placeholder="Series Name" style="width:50%;">
                            <div style="display:flex; gap:5px; align-items:center;">
                                <label style="font-size:0.7rem; color:#aaa;">Color:</label>
                                <input type="color" class="s-color" value="${color}" style="width:30px; height:30px; padding:0; border:none; cursor:pointer;">
                            </div>
                            <button class="btn-reset" style="color:red; border-color:red;" onclick="this.parentElement.parentElement.remove()">Del</button>
                        </div>
                        <div style="display:grid; grid-template-columns:repeat(6, 1fr); gap:2px;">${valInputs}</div>
                    `;
                    return div;
                },

                updateWafflePreview: () => {
                    const total = parseInt(getEl('tkWaffleTotal').value) || 0;
                    const active = parseInt(getEl('tkWaffleActive').value) || 0;
                    const colorVal = getEl('tkWaffleColorVal').value;
                    const colorBg = getEl('tkWaffleColorBg').value;
                    
                    const p = getEl('wafflePreview');
                    let html = '';
                    for(let i=0; i<100; i++) {
                        const isActive = i < active;
                        html += `<div class="waffle-cell" style="${isActive ? `background-color:${colorVal}; box-shadow: 0 0 2px ${colorVal}` : `background-color:${colorBg}`}"></div>`;
                    }
                    p.innerHTML = html;
                },

                submitTracker: () => {
                    const index = State.editingTrackerIndex;
                    const desc = getEl('tkDesc').value;
                    if (!desc) return App.alert("Title required");

                    const type = State.currentTrackerType;
                    let newTracker = { desc, type };

                    if (type === 'gauge') {
                        const m = getEl('tkMetric').value;
                        const c = parseFloat(getEl('tkComp').value) || 0;
                        const t = parseFloat(getEl('tkTotal').value) || 0;
                        if(t<=0) return App.alert("Total > 0 required");
                        if(c>t) return App.alert("Completed value cannot exceed Total value.");
                        newTracker.metric = m;
                        newTracker.completed = c;
                        newTracker.total = t;
                        newTracker.colorVal = getEl('tkPieColor').value; 
                    } else if (type === 'bar') {
                        const y = getEl('tkBarYLabel').value;
                        const labels = [];
                        for(let k=0; k<24; k++) {
                            const l = getEl(`bLbl${k}`).value;
                            if(l) labels.push(l);
                        }
                        const series = [];
                        const sDivs = getEl('barSeriesContainer').children;
                        for(let s of sDivs) {
                            const name = s.querySelector('.s-name').value;
                            const color = s.querySelector('.s-color').value;
                            const vals = [];
                            s.querySelectorAll('.sv-input').forEach((inp, k) => {
                                if(k < labels.length) vals.push(parseFloat(inp.value)||0);
                            });
                            series.push({name, color, values: vals});
                        }
                        if(series.length === 0) return App.alert("Add at least one series");
                        newTracker.yLabel = y;
                        newTracker.labels = labels;
                        newTracker.series = series;
                    } else if (type === 'line') {
                        const labels = [];
                        for(let k=0; k<24; k++) {
                            const l = getEl(`lLbl${k}`).value;
                            if(l) labels.push(l);
                        }
                        if(labels.length < 2) return App.alert("Add at least 2 X-Axis labels");

                        const series = [];
                        const sDivs = getEl('lineSeriesContainer').children;
                        for(let s of sDivs) {
                            const name = s.querySelector('.s-name').value;
                            const color = s.querySelector('.s-color').value;
                            const vals = [];
                            s.querySelectorAll('.sv-input').forEach((inp, k) => {
                                if(k < labels.length) vals.push(parseFloat(inp.value)||0);
                            });
                            series.push({name, color, values: vals});
                        }
                        if(series.length === 0) return App.alert("Add at least one series");
                        newTracker.labels = labels;
                        newTracker.series = series;
                    } else if (type === 'counter') {
                        newTracker.value = parseFloat(getEl('tkCounterVal').value) || 0;
                        newTracker.subtitle = getEl('tkCounterSub').value;
                        newTracker.color1 = "#bb86fc";
                    } else if (type === 'rag') {
                        newTracker.type = 'rag'; 
                        newTracker.status = getEl('tkRagStatus').value;
                        newTracker.message = getEl('tkRagMsg').value;
                        newTracker.color1 = (newTracker.status === 'green' ? '#00e676' : (newTracker.status === 'amber' ? '#ffb300' : (newTracker.status === 'red' ? '#ff1744' : '#666666')));
                    } else if (type === 'waffle') {
                        newTracker.total = parseInt(getEl('tkWaffleTotal').value) || 100;
                        newTracker.active = parseInt(getEl('tkWaffleActive').value) || 0;
                        newTracker.colorVal = getEl('tkWaffleColorVal').value;
                        newTracker.colorBg = getEl('tkWaffleColorBg').value;
                    }

                    if(index > -1) {
                        // New Tracker: Just push
                        State.trackers.push(newTracker);
                    } else {
                        // Edit Tracker: Update existing
                        // Handle legacy data safely if needed (using new inputs as source)
                        State.trackers[index] = newTracker;
                    }

                    ModalManager.closeModal('trackerModal');
                    renderBoard();
                    console.log("Tracker saved:", type);
                },

                deleteTracker: (index) => {
                    App.confirm("Delete tracker?", () => {
                        State.trackers.splice(index, 1);
                        renderBoard();
                    });
                }
            };

            // --- USER MANAGER ---
            const UserManager = {
                openUserModal: (index) => {
                    console.log("Opening User Modal for index:", index);
                    if (document.body.classList.contains('publishing')) return;

                    const isEdit = index > -1;
                    getEl('editIndex').value = index;
                    getEl('modalTitle').innerText = isEdit ? 'Edit User' : 'Add New User';
                    getEl('deleteBtn').style.display = isEdit ? 'block' : 'none';

                    const member = isEdit ? State.members[index] : null;

                    getEl('mName').value = member ? member.name : '';
                    
                    const tasks = ['lwTask1','lwTask2','lwTask3','nwTask1','nwTask2','nwTask3'];
                    const mTasks = member ? member.lastWeek.tasks : [null,null,null];
                    const nTasks = member ? member.nextWeek.tasks : [null,null,null];
                    
                    tasks.forEach((tid, k) => {
                        let val = '';
                        if (k < 3 && mTasks[k]) val = mTasks[k].text;
                        if (k >= 3 && nTasks[k-3]) val = nTasks[k-3].text;
                        getEl(tid).value = val;
                    });

                    for(let j=0; j<5; j++) {
                        getEl(`lw${j}`).value = member ? member.lastWeek.load[j] : 'L';
                        getEl(`nw${j}`).value = member ? member.nextWeek.load[j] : 'L';
                    }

                    ModalManager.openModal('userModal');
                },

                submitUser: () => {
                    const i = parseInt(getEl('editIndex').value);
                    const n = getEl('mName').value;
                    if (!n) return App.alert("Name required");
                    console.log("Submitting user:", n, i);

                    const getLoad = (p) => [0,1,2,3,4].map(x => getEl(`${p}${x}`).value);
                    const getTasks = (prefix) => {
                        return [1,2,3].map(x => {
                            const text = getEl(`${prefix}Task${x}`).value;
                            return { text: text };
                        });
                    };

                    const newUser = {
                        id: Date.now(),
                        name: n,
                        lastWeek: { tasks: getTasks('lw'), load: getLoad('lw') },
                        nextWeek: { tasks: getTasks('nw'), load: getLoad('nw') }
                    };

                    if (i > -1) {
                        // Edit existing: Update while preserving flags
                        const oldUser = State.members[i];
                        newUser.id = oldUser.id;
                        newUser.lastWeek.tasks.forEach((t, idx) => {
                            if(oldUser.lastWeek.tasks[idx]) t.isTeamSuccess = oldUser.lastWeek.tasks[idx].isTeamSuccess;
                        });
                        newUser.nextWeek.tasks.forEach((t, idx) => {
                            if(oldUser.nextWeek.tasks[idx]) t.isTeamActivity = oldUser.nextWeek.tasks[idx].isTeamActivity;
                        });
                        State.members[i] = newUser;
                    } else {
                        State.members.push(newUser);
                    }

                    ModalManager.closeModal('userModal');
                    renderBoard();
                    console.log("User saved successfully");
                },

                deleteUser: () => {
                    App.confirm('Delete user?', () => {
                        const index = parseInt(getEl('editIndex').value);
                        if(index > -1) {
                            State.members.splice(index, 1);
                            ModalManager.closeModal('userModal');
                            renderBoard();
                        }
                    });
                },

                toggleSuccess: (i, x) => {
                    const t = State.members[i].lastWeek.tasks[x];
                    if(!t.isTeamSuccess) {
                        const count = State.members.reduce((acc, m) => acc + m.lastWeek.tasks.filter(task => task.isTeamSuccess).length, 0);
                        if(count >= 5) {
                            App.alert("Max 5 items.");
                            renderBoard();
                            return;
                        }
                        t.isTeamSuccess = !t.isTeamSuccess;
                        renderBoard();
                    }
                },

                toggleActivity: (i, x) => {
                    const t = State.members[i].nextWeek.tasks[x];
                    if(!t.isTeamActivity) {
                        const count = State.members.reduce((acc, m) => acc + m.nextWeek.tasks.filter(task => task.isTeamActivity).length, 0);
                        if(count >= 5) {
                            App.alert("Max 5 items.");
                            renderBoard();
                            return;
                        }
                        t.isTeamActivity = !t.isTeamActivity;
                        renderBoard();
                    }
                },

                resetSelections: (type) => {
                    App.confirm(`Reset all ${type==='success'?'Achievement':'Activity'} selections?`, () => {
                        State.members.forEach(m => {
                            const targetTasks = type === 'success' ? m.lastWeek.tasks : m.nextWeek.tasks;
                            targetTasks.forEach(t => t.isTeamSuccess = false);
                        });
                        renderBoard();
                    });
                },

                saveAdditionalInfo: () => {
                    State.additionalInfo = getEl('additionalInfoInput').value;
                    ModalManager.closeModal('infoModal');
                    renderBoard();
                }
            };

            // --- OVERVIEW MANAGER ---
            const OverviewManager = {
                handleOverviewClick: (type) => {
                    if (!document.body.classList.contains('publishing')) {
                        const title = type === 'success' ? "Top 5 Achievements" : "Top 5 Activities";
                        const containerId = type === 'success' ? 'teamSuccessList' : 'teamActivityList';
                        
                        getEl('zoomTitle').innerText = title;
                        getEl('zoomBody').className = 'zoom-body-text';
                        const content = getEl(containerId).innerHTML;
                        getEl('zoomBody').innerHTML = `<div class="zoomed-content"><ul>${content}</ul></div>`;
                        ModalManager.openModal('zoomModal');
                    }
                },

                handleInfoClick: () => {
                    if (document.body.classList.contains('publishing')) {
                        getEl('zoomTitle').innerText = "Additional Info";
                        getEl('zoomBody').className = 'zoom-body-text';
                        const content = getEl('additionalInfoPreview').innerHTML;
                        getEl('zoomBody').innerHTML = `<div class="zoomed-content">${content}</div>`;
                        ModalManager.openModal('zoomModal');
                    } else {
                        getEl('additionalInfoInput').value = State.additionalInfo || '';
                        ModalManager.openModal('infoModal');
                    }
                }
            };

            // --- DATA MANAGERS ---
            const DataSaver = {
                saveData: () => {
                    const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(State));
                    const a = document.createElement('a');
                    a.href = d;
                    a.download = "team_tracker.json";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                }
            };

            const DataLoader = {
                loadFromFile: (input) => {
                    const file = input.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        try {
                            const l = JSON.parse(content);
                            // Migration
                            if(l.members) {
                                l.members.forEach(m => {
                                    if(typeof m.nextWeek.tasks[0] === 'string') {
                                        m.nextWeek.tasks = m.nextWeek.tasks.map(t => ({text:t, isTeamActivity:false}));
                                    }
                                    if(typeof m.lastWeek.tasks[0] === 'string') {
                                        m.lastWeek.tasks = m.lastWeek.tasks.map(t => ({text:t, isTeamSuccess:false}));
                                    }
                                });
                            }
                            State = l;
                            renderBoard();
                            App.alert('Data loaded!');
                        } catch(x) {
                            console.error(x);
                            App.alert('Error reading file (Not a valid JSON)');
                        }
                    };
                    reader.readAsText(file);
                    input.value = '';
                }
            };

            const DataExporter = {
                exportCSV: () => {
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "Section,Title,Data1,Data2\n";
                    State.trackers.forEach(t => {
                        let row = `Tracker,"${t.desc}",`;
                        if(t.type === 'counter') row += `${t.value},"${t.subtitle}"`;
                        else if(t.type === 'waffle') row += `${t.active},${t.total}`;
                        else if(t.type === 'gauge') row += `${t.completed},${t.total}`;
                        else row += "Complex Data,See JSON";
                        csvContent += row + "\n";
                    });
                    State.members.forEach(m => {
                        let lwLoad = m.lastWeek.load.join('');
                        let row = `Member,"${m.name}","Load: ${lwLoad}","Successes: ${m.lastWeek.tasks.filter(t=>t.isTeamSuccess).length}"`;
                        csvContent += row + "\n";
                    });
                    const a = document.createElement('a');
                    a.href = encodeURI(csvContent);
                    a.download = "team_data_export.csv";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                }
            };

            // --- MODAL MANAGER ---
            const ModalManager = {
                openModal: (id) => {
                    console.log("Opening modal:", id);
                    const el = document.getElementById(id);
                    if (el) el.classList.add('active');
                },
                closeModal: (id) => {
                    const el = document.getElementById(id);
                    if (el) el.classList.remove('active');
                }
            };

            // --- APP GLOBALS ---
            const App = {
                init: () => {
                    // Call local init
                    initApp();
                },
                alert: (msg) => {
                    getEl('alertMessage').innerText = msg;
                    getEl('alertModal').classList.add('active');
                    console.log("Alert:", msg);
                },
                confirm: (msg, callback) => {
                    getEl('confirmMessage').innerText = msg;
                    const btn = getEl('confirmYesBtn');
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.addEventListener('click', () => {
                        if(callback) callback();
                        ModalManager.closeModal('confirmModal');
                    });
                    getEl('confirmModal').classList.add('active');
                },
                togglePublishMode: () => {
                    document.body.classList.toggle('publishing');
                },
                saveTitle: () => {
                    State.title = getEl('appTitle').innerText;
                    console.log("Title saved");
                }
            };

            // --- VISUALS MODULE ---
            const Visuals = {
                createLineChartSVG: (labels, series) => {
                    let max = 0;
                    series.forEach(s => s.values.forEach(v => { if(v > max) max = v; }));
                    if(max===0) max=10;
                    const w=300; const h=180; const pTop=30; const pBot=50; const pSide=30;
                    const gw=(w-(pSide*2))/(labels.length-1||1); const uh=h-pTop-pBot;

                    let paths = '';
                    let points = '';

                    series.forEach((s, si) => {
                        let p = '';
                        s.values.forEach((v, i) => {
                            const x = pSide + (i*gw);
                            const y = h-pBot - (v/max)*uh;
                            p += (i===0?'M':'L') + `${x},${y} `;
                            points += `<circle cx="${x}" cy="${y}" r="3" fill="${s.color}"/>`;
                        });
                        paths += `<path d="${p}" fill="none" stroke="${s.color}" stroke-width="2"/>`;
                    });

                    let lbls = '';
                    labels.forEach((l, i) => {
                        const x = pSide + (i*gw);
                        lbls += `<text x="${x}" y="${h-35}" text-anchor="middle" fill="#aaa" font-size="9">${l.substring(0,5)}</text>`;
                    });

                    let legHTML = '';
                    const legY = h - 10;
                    const legItemW = 50;
                    const totalLegW = series.length * legItemW;
                    const startX = (w - totalLegW) / 2;

                    series.forEach((s, i) => {
                        const lx = startX + (i * legItemW);
                        legHTML += `<circle cx="${lx}" cy="${legY}" r="3" fill="${s.color}"/><text x="${lx+10}" y="${legY+3}" fill="#aaa" font-size="8" text-anchor="start">${s.name.substring(0,8)}</text>`;
                    });

                    return `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}"><line x1="${pSide}" y1="${h-pBot}" x2="${w-pSide}" y2="${h-pBot}" stroke="#444"/>${paths}${points}${lbls}${legHTML}<text x="${pSide-5}" y="${pTop+10}" text-anchor="end" fill="#aaa" font-size="10">${max}</text><text x="${pSide-5}" y="${h-pBot}" text-anchor="end" fill="#aaa" font-size="10">0</text></svg>`;
                },

                createMultiBarChartSVG: (labels, series) => {
                    let max = 0;
                    series.forEach(s => s.values.forEach(v => { if(v > max) max = v; }));
                    if(max === 0) max = 10;
                    const w=300; const h=180; const pTop=20; const pBot=50; const pSide=30;
                    const groupWidth = (w-(pSide*2)) / labels.length;
                    const barWidth = (groupWidth * 0.8) / series.length; const uh = h-pTop-pBot;

                    let rects = '';
                    series.forEach((s, si) => {
                        s.values.forEach((v, i) => {
                            const bh = (v/max) * uh;
                            const x = pSide + (i * groupWidth) + (groupWidth * 0.1) + (si * barWidth); 
                            const y = h-pBot-bh;
                            rects += `<rect x="${x}" y="${y}" width="${barWidth-1}" height="${bh}" fill="${s.color}" rx="1"/>`;
                        });
                    });

                    let lbls = '';
                    labels.forEach((l, i) => {
                        const x = pSide + (i * groupWidth) + (groupWidth/2);
                        lbls += `<text x="${x}" y="${h-35}" text-anchor="middle" fill="#aaa" font-size="9">${l.substring(0,5)}</text>`;
                    });

                    let legHTML = '';
                    const legY = h - 10;
                    const legItemW = 50;
                    const totalLegW = series.length * legItemW;
                    const startX = (w - totalLegW) / 2;

                    series.forEach((s, i) => {
                        const lx = startX + (i * legItemW);
                        legHTML += `<circle cx="${lx}" cy="${legY}" r="3" fill="${s.color}"/><text x="${lx+10}" y="${legY+3}" fill="#aaa" font-size="8" text-anchor="start">${s.name.substring(0,8)}</text>`;
                    });

                    return `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}"><line x1="${pSide}" y1="${h-pBot}" x2="${w-pSide}" y2="${h-pBot}" stroke="#444"/>${rects}${lbls}${legHTML}<text x="${pSide-5}" y="${pTop+10}" text-anchor="end" fill="#aaa" font-size="10">${max}</text><text x="${pSide-5}" y="${h-pBot}" text-anchor="end" fill="#aaa" font-size="10">0</text></svg>`;
                },

                createBarChartSVG: (data, yLabel, color) => {
                    let max = 0; 
                    data.forEach(d => { if(d.val > max) max = d.val; }); 
                    if(max === 0) max = 10;
                    const w=300; const h=180; const pTop=20; const pBot=50; const pSide=25;
                    const bw=(w-(pSide*2))/data.length; const uh=h-pTop-pBot;
                    let bars='';
                    const fill = color || 'var(--chart-1)';
                    data.forEach((d, i) => {
                        const bh=(d.val/max)*uh; 
                        const x=pSide+(i*bw)+5; 
                        const y=h-pBot-bh;
                        bars+=`<rect x="${x}" y="${y}" width="${bw-10}" height="${bh}" fill="${fill}" rx="2"/><text x="${x+(bw-10)/2}" y="${y-5}" text-anchor="middle" fill="#fff" font-size="10">${d.val}</text><text x="${x+(bw-10)/2}" y="${h-15}" text-anchor="middle" fill="#aaa" font-size="10">${d.label.substring(0,5)}</text>`;
                    });
                    return `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}"><line x1="${pSide}" y1="${h-pBot}" x2="${w-pSide}" y2="${h-pBot}" stroke="#444"/><text transform="rotate(-90 ${pSide/2},${h/2})" x="${pSide/2}" y="${h/2}" text-anchor="middle" fill="#aaa" font-size="10">${yLabel}</text>${bars}</svg>`;
                }
            };

            // --- STARTUP ---
            window.addEventListener('DOMContentLoaded', () => {
                App.init();
                renderBoard();
            });

        })();
    </script>
</body>
</html>
